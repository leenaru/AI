> RAG ì™€ LLMì— ëª¨ë“  ë‚´ìš©ì„ ë‹¤ ë„£ê³  ì§ˆë¬¸í•˜ëŠ”ê²ƒê³¼ ì–´ë–¤ê²Œ ë” ì •í™•í• ê¹Œ? ë‘ ê°€ì§€ë¥¼ ë‹¤ê°ë„ë¡œ ë¹„êµí•´ë´

# ìš”ì•½(í•œ ì¤„ ê²°ë¡ )

* \*\*ì§€ì‹ì´ í¬ê³  ìì£¼ ë°”ë€ŒëŠ” ì‹¤ì œ ì„œë¹„ìŠ¤(IT/IoT í—¬í”„Â·ì˜¨ë³´ë”©Â·íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)\*\*ë¼ë©´ **RAG**ê°€ ë³´í†µ **ë” ì •í™•í•˜ê³  ì‹ ë¢° ê°€ëŠ¥í•œ ë‹µ**(ê·¼ê±°/ì¶œì²˜ ì œê³µ, ìµœì‹ ì„± ìœ ì§€)ì„ ëƒ…ë‹ˆë‹¤. ë°˜ëŒ€ë¡œ **ì§ˆë¬¸ì— í•„ìš”í•œ ì •ë³´ê°€ ì†Œìˆ˜ì˜ ë¬¸ì„œì— ëª¨ì—¬ ìˆê³  ë³€í™”ê°€ ì ìœ¼ë©°** ê¸¸ê²Œ ë¶™ì—¬ ë„£ì–´ë„ ëª¨ë¸ì´ í•µì‹¬ì„ ì˜ ì°¾ì„ ìˆ˜ ìˆë‹¤ë©´ \*\*ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸(â€œëª¨ë“  ë‚´ìš©ì„ í”„ë¡¬í”„íŠ¸ì— ë„£ê¸°â€)\*\*ê°€ ê°„ë‹¨í•˜ê³  ë¹ ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ë§Œ ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸ëŠ” **ì¤‘ê°„ì— ìˆëŠ” ê·¼ê±°ë¥¼ ë†“ì¹˜ëŠ” ìœ„ì¹˜ ë°”ì´ì–´ìŠ¤**ê°€ ì—¬ì „íˆ ë³´ê³ ë˜ê³  ìˆê³ , ì—°êµ¬ë³„ë¡œ **RAGê°€ ìš°ì„¸** í˜¹ì€ **ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸ê°€ ìš°ì„¸**ë¼ëŠ” **ìƒë°˜ ê²°ê³¼**ê°€ ê³µì¡´í•˜ë‹ˆ **ì—…ë¬´ ë°ì´í„°ë¡œ A/B í‰ê°€**ê°€ í•„ìˆ˜ì…ë‹ˆë‹¤. ([arXiv][1], [ACL Anthology][2], [OpenReview][3])

---

## í•µì‹¬ ìš”ì•½

* **ì •í™•ë„(ì •ë‹µë¥ /íŒ©íŠ¸ì„±)**

  * ì—¬ëŸ¬ ì—°êµ¬ì—ì„œ **RAGê°€ ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸ë³´ë‹¤ ì •í™•**í•˜ë‹¤ëŠ” ë³´ê³ ê°€ ìˆê³ (íŠ¹íˆ ëŒ€í™”í˜•/ì¼ë°˜ ì§ˆì˜), ë°˜ëŒ€ë¡œ **ë°±ê³¼ì‚¬ì „í˜• QA**ì—ì„  **ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸ê°€ ìš°ì„¸**í•˜ë‹¤ëŠ” ì¬í‰ê°€ë„ ìˆìŠµë‹ˆë‹¤ â†’ **ë„ë©”ì¸ê³¼ íƒœìŠ¤í¬ì— ë”°ë¼ ìŠ¹ë¶€ê°€ ê°ˆë¦½ë‹ˆë‹¤.** ([OpenReview][3], [arXiv][4])
  * ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸ëŠ” â€œ**ì¤‘ê°„ì„ ìƒëŠ” í˜„ìƒ(Lost in the Middle)**â€ìœ¼ë¡œ ì¤‘ìš”í•œ ê·¼ê±°ë¥¼ ë†“ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ìµœê·¼ ë³´ì™„ ì—°êµ¬ë„ ìˆìœ¼ë‚˜ ì™„ì „ í•´ê²°ì€ ì•„ë‹˜). ([arXiv][1], [ACL Anthology][2])
  * **ìê¸°ë°˜ì„±í˜• RAG(Self-RAG)** ê°™ì€ í•˜ì´ë¸Œë¦¬ë“œëŠ” íŒ©íŠ¸ì„±ê³¼ ì¸ìš© ì •í™•ë„ë¥¼ ê¾¸ì¤€íˆ ëŒì–´ì˜¬ë ¸ìŠµë‹ˆë‹¤. ([arXiv][5], [OpenReview][6], [selfrag.github.io][7])

* **ìµœì‹ ì„±Â·ì§€ì‹ ì—…ë°ì´íŠ¸**

  * RAGëŠ” **ì§€ì‹ ë² ì´ìŠ¤ë§Œ êµì²´/ì¦ë¶„ ì¸ë±ì‹±**í•˜ë©´ ìµœì‹  ìƒíƒœ ìœ ì§€ê°€ ì‰½ê³ , **ì¶œì²˜ ë§í¬**ë¥¼ ì œì‹œí•˜ê¸° ì¢‹ìŠµë‹ˆë‹¤. (RAG ì›ì „) ([arXiv][8])
  * ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸ëŠ” ë§¤ ì§ˆì˜ ë•Œ **ê´€ë ¨ ì—†ëŠ” ëŒ€ëŸ‰ í† í°ì„ í•¨ê»˜ ì „ì†¡**í•˜ê¸° ì‰¬ì›Œ **ë¹„ìš©ê³¼ ì§€ì—°**ì´ ì»¤ì§€ê³ , **ì¶œì²˜ ê´€ë¦¬**ê°€ ì²´ê³„ì ì´ì§€ ì•Šìœ¼ë©´ ê²€ì¦ì´ ì–´ë µìŠµë‹ˆë‹¤.

* **ì„±ëŠ¥Â·ë¹„ìš©(í† í°/ì§€ì—°)**

  * íŠ¸ëœìŠ¤í¬ë¨¸ ì£¼ì˜(attention)ëŠ” \*\*ì‹œí€€ìŠ¤ ê¸¸ì´ $n$\*\*ì— ëŒ€í•´ \*\*ê³„ì‚°ëŸ‰ì´ ìµœì†Œ $O(n^2)$\*\*ë¡œ ì¦ê°€í•©ë‹ˆë‹¤(FlashAttentionì€ ë©”ëª¨ë¦¬/IOë¥¼ ì¤„ì—¬ë„ **ë³µì¡ë„ ìì²´ëŠ” ìœ ì§€**). â†’ **ê¸´ í”„ë¡¬í”„íŠ¸ëŠ” ë¹„ìš©Â·ì§€ì—°ì´ ê¸‰ì¦**í•©ë‹ˆë‹¤. ([arXiv][9], [NeurIPS Proceedings][10])
  * RAGëŠ” \*\*ì‘ì€ ì§ˆì˜ + ì†Œìˆ˜ ë¬¸ì„œ(kê°œ)\*\*ë§Œ ëª¨ë¸ì— íˆ¬ì… â†’ **í† í°Â·ì§€ì—°Â·ë¹„ìš©ì„ ìƒí•œ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

* **ë‹¤êµ­ì–´(í•œêµ­ì–´+ì˜ì–´ í˜¼ì¬)**

  * **ë‹¤êµ­ì–´ ì„ë² ë”©**(ì˜ˆ: **BGE-M3**, **jina-embeddings-v3**)ì„ ì“°ë©´ í•œêµ­ì–´/ì˜ì–´ê°€ ì„ì¸ KBì—ì„œë„ **ê²€ìƒ‰-ì •í™•ë„**ê°€ ë†’ìŠµë‹ˆë‹¤. ([arXiv][11], [ACL Anthology][12])

* **ì¶”ì²œ**

  * ê·€í•˜ì˜ **IT/IoT ì˜¨ë³´ë”©Â·íŠ¸ëŸ¬ë¸”ìŠˆíŒ…**ì—ëŠ” \*\*RAG(+ìš”ì²­ë³„ ë™ì  ê²€ìƒ‰)\*\*ì´ ê¸°ë³¸ê°’, **ì‘ì€ ê³ ì • ë¬¸ë‹µ/ì˜¤í”„ë¼ì¸**ì€ ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸ ë³´ì¡°.
  * **í•˜ì´ë¸Œë¦¬ë“œ**(â€œí•„ìš” ì‹œì—ë§Œ ê²€ìƒ‰â€) ê²Œì´íŠ¸ë¥¼ ë‘ë©´ \*\*ì •í™•ë„â†‘ ë¹„ìš©â†“\*\*ë¥¼ ë™ì‹œì— ë‹¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ([arXiv][5])

---

# ìƒì„¸ ë¹„êµ

### 1) ë¬´ì—‡ì´ â€œë” ì •í™•í•œê°€?â€ â€” **ì¼€ì´ìŠ¤ë³„ ìŠ¹ë¶€**

| ìƒí™©                                   | ë” ìœ ë¦¬í•œ ìª½               | ì´ìœ                                                     |
| ------------------------------------ | --------------------- | ----------------------------------------------------- |
| **ëŒ€ê·œëª¨Â·ì´ì§ˆì Â·ìì£¼ ê°±ì‹ ** KB (ë§¤ë‰´ì–¼, í¬ëŸ¼, ì´ìŠˆë¡œê·¸) | **RAG**               | ìµœì‹ ì„±Â·ì¶œì²˜Â·ìŠ¤ì¼€ì¼. ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸ëŠ” ë¶ˆí•„ìš” í† í° ì¦ê°€Â·ê·¼ê±° ëˆ„ë½ ìœ„í—˜. ([arXiv][8]) |
| **ë°±ê³¼ì‚¬ì „í˜•/ë‹¨ì¼ ì½”í¼ìŠ¤ QA**                  | **ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸ê°€ ìš°ì„¸í•  ìˆ˜ ìˆìŒ** | ìµœê·¼ ì¬í‰ê°€ì—ì„œ ìœ„í‚¤ ê¸°ë°˜ QAì—ì„  ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸ê°€ ìœ ë¦¬í•˜ë‹¤ëŠ” ê²°ê³¼. ([arXiv][4])   |
| **ëŒ€í™”í˜•/ì¼ë°˜ ì§ˆì˜**                        | **RAG ìš°ì„¸** ê²½í–¥ ë³´ê³       | ë‹¤ì–‘í•œ íƒœìŠ¤í¬ì—ì„œ RAGê°€ ë‹µë³€ ì •í™•ë„ì—ì„œ ìš°ìœ„ ë³´ê³ . ([OpenReview][3])      |
| **ë³µì¡ ì¥ë¬¸ ë¬¸ì„œ ë‚´ ë‹¤ë‹¨ê³„ ê·¼ê±° ê²°í•©**             | **RAG(ê³„ì¸µí˜•/ìš”ì•½í˜• ë¦¬íŠ¸ë¦¬ë²Œ)** | RAPTOR ê°™ì€ íŠ¸ë¦¬í˜• ìš”ì•½Â·ì¬ê·€ ê²€ìƒ‰ì´ ì¥ë¬¸ í•©ì„±ì— ê°•ì . ([arXiv][13])      |
| **ì¸í„°ë„· ì°¨ë‹¨/ì˜¤í”„ë¼ì¸, ì†Œí˜• KB**               | **ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸**           | ê°„ë‹¨Â·êµ¬ì¶• ë‚œì´ë„â†“. KBê°€ ì‘ê³  ì •ì ì´ë©´ ì¶©ë¶„.                           |

> ì°¸ê³ : â€œ**Lost in the Middle**â€ëŠ” ì¥ë¬¸ ì…ë ¥ì—ì„œ **ì´ˆì¤‘ë°˜ ê·¼ê±°ë¥¼ ë†“ì¹˜ëŠ” ìœ„ì¹˜ ë°”ì´ì–´ìŠ¤**ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤. ë³´ì • ì—°êµ¬ê°€ ìˆìœ¼ë‚˜ **ì™„ì „ í•´ê²°ì€ ì•„ë‹˜**â€”ë”°ë¼ì„œ ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸ ì „ëµì´ë¼ë„ **ë¬¸ì„œ ìˆœì„œÂ·ìš”ì•½Â·í—¤ë”** ì„¤ê³„ë¥¼ ì˜ í•´ì•¼ í•©ë‹ˆë‹¤. ([arXiv][1], [ACL Anthology][2])

---

### 2) ìµœì‹ ì„±Â·ê·¼ê±° ì œì‹œÂ·ìš´ì˜ ê´€ì 

* **RAG**: ë¬¸ì„œ êµì²´Â·ì¦ë¶„ ì¸ë±ì‹±ìœ¼ë¡œ **ì§€ì‹ ì—…ë°ì´íŠ¸ê°€ ì‰¬ì›€**, **URL/ë¬¸ì„œIDë¥¼ í•¨ê»˜ ì œì‹œ**í•´ **ê²€ì¦ê°€ëŠ¥ì„±**ì´ ë†’ìŒ(ì›ì „ ì·¨ì§€). ([arXiv][8])
* **ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸**: ìƒˆ ì§€ì‹ì„ ì“°ë ¤ë©´ **ë§¤ë²ˆ í”„ë¡¬í”„íŠ¸ì— ë„£ê±°ë‚˜ ì¬í•™ìŠµ**. ì¶œì²˜ê°€ ì„ì´ë©´ **ê·¼ê±° ì¶”ì **ì´ ì–´ë µìŠµë‹ˆë‹¤.

---

### 3) ì„±ëŠ¥Â·ë¹„ìš©Â·ë ˆì´í„´ì‹œ

* **ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸**: ì…ë ¥ ê¸¸ì´ì— ë”°ë¼ attention ì—°ì‚°ì´ **ê¸‰ê²©íˆ ì¦ê°€**(ìµœì†Œ $O(n^2)$); FlashAttentionì€ **ë©”ëª¨ë¦¬/IOëŠ” ì¤„ì—¬ë„** ê³„ì‚° ë³µì¡ë„ëŠ” ìœ ì§€ â†’ **ë¡± ì»¨í…ìŠ¤íŠ¸ëŠ” ê³§ ë¹„ìš©**ì…ë‹ˆë‹¤. ([arXiv][9], [NeurIPS Proceedings][10])
* **RAG**: ê²€ìƒ‰(ì¸ë±ìŠ¤ íƒìƒ‰) + ì§§ì€ ì»¨í…ìŠ¤íŠ¸ â†’ **í† í° ì˜ˆì‚° ê³ ì •í™”**ê°€ ì‰¬ì›Œ **ì§€ì—°Â·ë¹„ìš© ì˜ˆì¸¡ì„±**ì´ ì¢‹ìŠµë‹ˆë‹¤.

---

### 4) ë‹¤êµ­ì–´(KO+EN í˜¼ì¬) ì •í™•ë„

* **ë©€í‹°ë§êµ¬ì–¼ ì„ë² ë”©**ì„ ì“°ë©´ **êµì°¨ì–¸ì–´ ë§¤ì¹­**(í•œêµ­ì–´ ì§ˆë¬¸ â†” ì˜ì–´ ë¬¸ì„œ)ì´ í–¥ìƒë©ë‹ˆë‹¤.

  * ê¶Œì¥: **BGE-M3**(ë‹¤êµ­ì–´Â·ë‹¤ê¸°ëŠ¥Â·ë‹¤ì…ë„, 8K í† í°), **jina-embeddings-v3**(ë‹¤êµ­ì–´ SOTA ë³´ê³ ). ([arXiv][11], [ACL Anthology][12])

---

### 5) ì‹¤ë¬´ ì„¤ê³„ íŒ(ì •í™•ë„ ìµœì í™”)

1. **â€œê²€ìƒ‰ í•„ìš” ì—¬ë¶€â€ ê²Œì´íŒ…**:

* *ê·œì¹™*: â€œìµœê·¼/ê³ ìœ ëª…ì‚¬/ë²„ì „/ë§í¬ ìš”êµ¬/ìˆ˜ì¹˜â€ í¬í•¨ ì‹œ **ê²€ìƒ‰**.
* *ëª¨ë¸*: **Self-RAG**ì²˜ëŸ¼ **ìê¸°ë°˜ì„± í† í°**ìœ¼ë¡œ â€œê²€ìƒ‰í• ì§€/ëª‡ ê°œ ê°€ì ¸ì˜¬ì§€/ì¬ê²€ìƒ‰í• ì§€â€ë¥¼ ìŠ¤ìŠ¤ë¡œ ê²°ì •. ([arXiv][5])

2. **ë¦¬íŠ¸ë¦¬ë²Œ í’ˆì§ˆ**:

* **í•˜ì´ë¸Œë¦¬ë“œ**(BM25+Dense) + **RRF ì¬ë­í¬**ë¡œ recall/precision ê· í˜•.
* \*\*ê³„ì¸µí˜• ë¦¬íŠ¸ë¦¬ë²Œ(RAPTOR)\*\*ë¡œ ì¥ë¬¸Â·ë§¤ë‰´ì–¼ í†µí•© ì§ˆì˜ì— ê°•í•¨. ([arXiv][13])

3. **ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±**:

* \*\*ë¬¸ë‹¨ ìš”ì•½ + í—¤ë”(ì œëª©/ë²„ì „/ì–¸ì–´ íƒœê·¸)\*\*ë¥¼ í•¨ê»˜ ì£¼ì… â†’ â€œì¤‘ê°„ ì†ì‹¤â€ ì™„í™”. (Lost-in-the-Middle ë³´ì •ì— ë„ì›€) ([arXiv][1])

4. **ë‹¤êµ­ì–´ ì¸ë±ìŠ¤**:

* ë¬¸ì„œì— `lang: ko|en` ë©”íƒ€Â·ë²ˆì—­ ì œëª© í‚¤ì›Œë“œ ì¶”ê°€, ì„ë² ë”©ì€ **bge-m3/jina-v3**. ([arXiv][11])

5. **í‰ê°€Â·ê´€ì¸¡**:

* **RAGAS**ë¡œ *Answer Correctness, Faithfulness, Context Recall/Precision* ì¸¡ì •,
* **Needle-in-a-Haystack**ë¡œ ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸ ì‚¬ìš©ì„± í…ŒìŠ¤íŠ¸. ([ragas.io][14], [Medium][15], [GitHub][16])
* RAG ì „ìš© **ì„œë² ì´/íŠœí† ë¦¬ì–¼Â·ì„œë² ì´** ì°¸ê³ . ([arXiv][17])

---

### 6) ì„ íƒ ê°€ì´ë“œ(ì˜ì‚¬ê²°ì • íŠ¸ë¦¬)

1. **KB ê·œëª¨ê°€ í¬ê³  ìì£¼ ë°”ë€Œë‚˜?** â†’ **ì˜ˆ**: RAG ê¸°ë³¸.
2. **ë‹µë³€ì— ì¶œì²˜(ë§í¬) í•„ìš”? ê·œì œ/ê°ì‚¬ ìš”êµ¬?** â†’ **ì˜ˆ**: RAG. ([arXiv][8])
3. **ì˜¤í”„ë¼ì¸/ì†Œí˜• KB/ê³ ì • FAQ?** â†’ ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸(ê°„ë‹¨Â·ë°°í¬ ìš©ì´).
4. **ë¬¸ì„œê°€ ê¸¸ê³  ë‹¨ê³„ì  ê²°í•©ì´ í•„ìš”í•œê°€?** â†’ RAG(+RAPTOR). ([arXiv][13])
5. **ë°±ê³¼ì‚¬ì „í˜• ì§ˆì˜Â·ë‹¨ì¼ ì½”í¼ìŠ¤?** â†’ ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸ë„ ê°•í•¨(ì‹¤í—˜ ë³´ê³ ). ([arXiv][4])

---

## ê·€í•˜(í•œêµ­/ë‹¤êµ­ì–´, IT/IoT ì˜¨ë³´ë”©Â·íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)ì—ê²Œì˜ ì‹¤ì „ ê¶Œì¥ì•ˆ

1. **ê¸°ë³¸**: **RAG**(BM25+Dense í•˜ì´ë¸Œë¦¬ë“œ, RRF ì¬ë­í¬).

* **ì„ë² ë”©**: **BGE-M3** ë˜ëŠ” **jina-embeddings-v3** (í•œêµ­ì–´/ì˜ì–´ í˜¼í•© ìµœì í™”). ([arXiv][11])
* **ê³„ì¸µí˜• ê²€ìƒ‰**: ë§¤ë‰´ì–¼Â·í¬ëŸ¼ ê°™ì€ **ì¥ë¬¸**ì—” **RAPTOR**ë¥¼ ë³‘í–‰. ([arXiv][13])
* **ê²Œì´íŒ…**: Self-RAGì‹ â€œê²€ìƒ‰ í•„ìš”â€ íŒë‹¨ìœ¼ë¡œ **ë¶ˆí•„ìš” ê²€ìƒ‰ ì–µì œ**. ([arXiv][5])

2. **ë³´ì¡°**: **ë¡±-ì»¨í…ìŠ¤íŠ¸ ë²„í¼**

* ìì£¼ ë¬»ëŠ” ì†Œìˆ˜ ë¬¸ì„œ(â€œë¹ ë¥¸ ì‹œì‘/ëª¨ë¸ë³„ ìŠ¤í™í‘œâ€)ëŠ” **ì§ˆë¬¸ ì„¸ì…˜ ë²„í¼**ì— **ì••ì¶• ìš”ì•½**ìœ¼ë¡œ ìœ ì§€ â†’ **ì§€ì—° ìµœì†Œí™”**(í•„ìš” ì‹œë§Œ RAG).

3. **í‰ê°€/ê´€ì¸¡ ë£¨í”„**

* **RAGAS**ë¡œ ì£¼/ì›”ê°„ ì •í™•ë„Â·ê·¼ê±°ì¶©ì‹¤ë„ íŠ¸ë˜í‚¹,
* **Needle í…ŒìŠ¤íŠ¸**ë¡œ ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸ í’ˆì§ˆ ì ê²€(â€œì¤‘ê°„ ê·¼ê±°â€ íƒìƒ‰ë¥ ). ([ragas.io][14], [GitHub][16])

---

## ë³´ë„ˆìŠ¤: â€œì™œ ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸ê°€ ë¹„ì‹¼ê°€ìš”?â€

* íŠ¸ëœìŠ¤í¬ë¨¸ëŠ” ì…ë ¥ ê¸¸ì´ $n$ì— ëŒ€í•´ \*\*ì£¼ì˜ ê³„ì‚°ëŸ‰ì´ ìµœì†Œ $O(n^2)$\*\*ë¡œ ëŠ˜ì–´ë‚©ë‹ˆë‹¤. **FlashAttention**ì€ **ë©”ëª¨ë¦¬/IO ìµœì í™”**ë¡œ ì†ë„Â·ë©”ëª¨ë¦¬ë¥¼ ì¤„ì´ì§€ë§Œ, **ì´ë¡ ì  ì—°ì‚° ì°¨ìˆ˜ëŠ” ê·¸ëŒ€ë¡œ**ì´ë¯€ë¡œ í”„ë¡¬í”„íŠ¸ê°€ ê¸¸ì–´ì§ˆìˆ˜ë¡ ë¹„ìš©Â·ì§€ì—°ì€ ê³„ì† ì»¤ì§‘ë‹ˆë‹¤. ([arXiv][9], [NeurIPS Proceedings][10])

---

## ì—°êµ¬ ê·¼ê±°(í´ë¦­í•´ í™•ì¸)

* **ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸ í•œê³„/ë³´ì •**: *Lost in the Middle* & TACL ë²„ì „, *Found in the Middle*. ([arXiv][1], [ACL Anthology][2])
* **RAG ì›ì „**: *Retrieval-Augmented Generation for Knowledge-Intensive NLP*. ([arXiv][8])
* **RAG vs ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸ ë¹„êµ ì—°êµ¬(ìƒë°˜ ê²°ê³¼ ê³µì¡´)**: OpenReview 2024(â€œRAG ìš°ì„¸â€), arXiv 2024/2025(â€œì¥ë¬¸ ìš°ì„¸ ì‚¬ë¡€â€). ([OpenReview][3], [arXiv][4])
* **ìê¸°ë°˜ì„±í˜• RAG(Self-RAG)**: ë…¼ë¬¸/í”„ë¡œì íŠ¸ í˜ì´ì§€. ([arXiv][5], [selfrag.github.io][7])
* **ë¡±ì»¨í…ìŠ¤íŠ¸ ë²¤ì¹˜**: Needle-in-a-Haystack(í…ìŠ¤íŠ¸/ë©€í‹°ëª¨ë‹¬). ([GitHub][16], [arXiv][18], [ACL Anthology][19])
* **RAG í‰ê°€ ì„œë² ì´ & ë„êµ¬**: RAG í‰ê°€ ì„œë² ì´, RAGAS. ([arXiv][17], [ragas.io][14])
* **ë‹¤êµ­ì–´ ì„ë² ë”©**: BGE-M3, jina-embeddings-v3. ([arXiv][11], [ACL Anthology][12])
* **ê¸´ í”„ë¡¬í”„íŠ¸ì˜ ê³„ì‚° ë³µì¡ë„**: Transformer/FlashAttention. ([arXiv][9])

---

## ë§ˆë¬´ë¦¬ ì œì•ˆ(ì‹¤í–‰ ìˆœì„œ)

1. í˜„ì¬ KB(í•œêµ­ì–´+ì˜ì–´)ë¡œ **ì‘ì€ ê³¨ë“ ì…‹**ì„ ë§Œë“¤ê³ ,
2. **(A) RAG íŒŒì´í”„ë¼ì¸** vs **(B) ì¥ë¬¸ ì»¨í…ìŠ¤íŠ¸ ë²„í¼** vs **(C) í•˜ì´ë¸Œë¦¬ë“œ(Self-RAG ê²Œì´íŒ…)** ë¥¼ **ë™ì¼ ì§ˆì˜**ë¡œ **RAGAS** í‰ê°€,
3. **ì •í™•ë„/ê·¼ê±°ì¶©ì‹¤ë„/ì§€ì—°/í† í°ë¹„ìš©**ì„ í‘œì¤€í™”í•´ \*\*ì •ì±…(ê²Œì´íŠ¸ ì„ê³„ê°’Â·top-kÂ·ì»¨í…ìŠ¤íŠ¸ ê¸¸ì´)\*\*ë¥¼ í™•ì •í•˜ì‹­ì‹œì˜¤. ([ragas.io][14])

í•„ìš”í•˜ì‹œë©´, ìœ„ í‰ê°€ë¥¼ ë°”ë¡œ ëŒë¦´ ìˆ˜ ìˆëŠ” **ìƒ˜í”Œ ìŠ¤í¬ë¦½íŠ¸/íŒŒì´í”„ë¼ì¸**(BGE-M3 + BM25 + RRF + RAPTOR ì˜µì…˜ + RAGAS í‰ê°€)ì„ ë§Œë“¤ì–´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

[1]: https://arxiv.org/abs/2307.03172?utm_source=chatgpt.com "Lost in the Middle: How Language Models Use Long Contexts - arXiv"
[2]: https://aclanthology.org/2024.tacl-1.9/?utm_source=chatgpt.com "Lost in the Middle: How Language Models Use Long Contexts"
[3]: https://openreview.net/forum?id=k3ibnAmzKG&utm_source=chatgpt.com "RAG vs. Long Context: Examining Frontier Large ..."
[4]: https://arxiv.org/abs/2501.01880?utm_source=chatgpt.com "Long Context vs. RAG for LLMs: An Evaluation and Revisits"
[5]: https://arxiv.org/abs/2310.11511?utm_source=chatgpt.com "Self-RAG: Learning to Retrieve, Generate, and Critique through Self-Reflection"
[6]: https://openreview.net/pdf?id=hSyW5go0v8&utm_source=chatgpt.com "SELF-RAG: LEARNING TO RETRIEVE, GENERATE, AND ..."
[7]: https://selfrag.github.io/?utm_source=chatgpt.com "Self-RAG: Learning to Retrieve, Generate and Critique ..."
[8]: https://arxiv.org/abs/2005.11401?utm_source=chatgpt.com "Retrieval-Augmented Generation for Knowledge-Intensive NLP Tasks"
[9]: https://arxiv.org/abs/1706.03762?utm_source=chatgpt.com "[1706.03762] Attention Is All You Need"
[10]: https://proceedings.neurips.cc/paper_files/paper/2022/file/67d57c32e20fd0a7a302cb81d36e40d5-Supplemental-Conference.pdf?utm_source=chatgpt.com "Fast and Memory-Efficient Exact Attention with IO-Awareness"
[11]: https://arxiv.org/abs/2402.03216?utm_source=chatgpt.com "BGE M3-Embedding: Multi-Lingual, Multi-Functionality, Multi-Granularity Text Embeddings Through Self-Knowledge Distillation"
[12]: https://aclanthology.org/2024.findings-acl.137/?utm_source=chatgpt.com "M3-Embedding: Multi-Linguality, Multi-Functionality, ..."
[13]: https://arxiv.org/abs/2401.18059?utm_source=chatgpt.com "RAPTOR: Recursive Abstractive Processing for Tree-Organized Retrieval"
[14]: https://www.ragas.io/?utm_source=chatgpt.com "Ragas"
[15]: https://medium.com/data-science/evaluating-rag-applications-with-ragas-81d67b0ee31a?utm_source=chatgpt.com "Evaluating RAG Applications with RAGAs"
[16]: https://github.com/gkamradt/LLMTest_NeedleInAHaystack?utm_source=chatgpt.com "gkamradt/LLMTest_NeedleInAHaystack"
[17]: https://arxiv.org/html/2405.07437v2?utm_source=chatgpt.com "Evaluation of Retrieval-Augmented Generation: A Survey"
[18]: https://arxiv.org/abs/2406.11230?utm_source=chatgpt.com "Multimodal Needle in a Haystack: Benchmarking Long ..."
[19]: https://aclanthology.org/2025.naacl-long.166.pdf?utm_source=chatgpt.com "Multimodal Needle in a Haystack: Benchmarking Long- ..."

---

> ê³„ì¸µí˜• retrieval ì— ëŒ€í•´ ìì„¸íˆ ì•Œë ¤ì¤˜. ì˜ˆì‹œë¥¼ ë³´ì—¬ì£¼ê³  ì½”ë“œë„ ì œì‹œí•´ì¤˜

# ìš”ì•½

* \*\*ê³„ì¸µí˜• ë¦¬íŠ¸ë¦¬ë²Œ(Hierarchical Retrieval)\*\*ì€ ë¬¸ì„œ â†’ ì„¹ì…˜(ë˜ëŠ” í´ëŸ¬ìŠ¤í„°/ìš”ì•½) â†’ ë¬¸ë‹¨/ë¬¸ì¥ ìˆœìœ¼ë¡œ â€œêµµê²Œ ê³ ë¥´ê³ , ì ì  ì´˜ì´˜íˆ ê³ ë¥´ëŠ”â€ **ë‹¤ë‹¨ê³„ ê²€ìƒ‰ ì „ëµ**ì…ë‹ˆë‹¤. ê¸´ ë§¤ë‰´ì–¼Â·ë‹¤êµ­ì–´ KB ê°™ì€ **ì¥ë¬¸Â·ëŒ€ê·œëª¨ ì§€ì‹**ì—ì„œ \*\*ì •í™•ë„(ì •ë‹µë¥ /ê·¼ê±°ì¶©ì‹¤ë„)\*\*ì™€ \*\*íš¨ìœ¨(í† í°/ì§€ì—°/ë¹„ìš©)\*\*ì„ ë™ì‹œì— ê°œì„ í•©ë‹ˆë‹¤. íŠ¹íˆ â€œ**ì¤‘ê°„ ê·¼ê±°ë¥¼ ë†“ì¹˜ëŠ”**â€ ë¡±ì»¨í…ìŠ¤íŠ¸ í•œê³„ë¥¼ ì¤„ì´ëŠ” ë° ìœ ë¦¬í•©ë‹ˆë‹¤.
* ëŒ€í‘œ ë°©ì‹ì€ **RAPTOR(ìš”ì•½ íŠ¸ë¦¬ ê¸°ë°˜)**, **ì„¹ì…˜â†’ë¬¸ë‹¨ 2ë‹¨ê³„ ê²€ìƒ‰**, **ì¦ë¶„/ë³´ì¶© ì§ˆì˜ + RRF ìœµí•©** ë“±ì´ ìˆìœ¼ë©°, ë‹¤êµ­ì–´ í™˜ê²½ì—ì„œëŠ” **BGE-M3**ë‚˜ **jina-embeddings-v3** ê°™ì€ ë©€í‹°ë§êµ¬ì–¼ ì„ë² ë”©ê³¼ ê²°í•©í•˜ëŠ” ê²ƒì´ íš¨ê³¼ì ì…ë‹ˆë‹¤.
* ì•„ë˜ì— **ì‹¤ì „ ì„¤ê³„ íŒ¨í„´**ê³¼ **íŒŒì´ì¬ ì˜ˆì œ ì½”ë“œ**(FAISS + BM25 + RRF + ì„ íƒì  í¬ë¡œìŠ¤-ë¦¬ë­ì»¤)ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ê·¸ëŒ€ë¡œ ì‹¤í–‰í•˜ë©´ \*\*ì„¹ì…˜-ìš°ì„ (ìƒìœ„ ìˆ˜ì¤€)\*\*ìœ¼ë¡œ ì¢íˆê³ , ì´ì–´ì„œ **ë¬¸ë‹¨-ì •ë°€(í•˜ìœ„ ìˆ˜ì¤€)** ê²€ìƒ‰ ë° **ìœµí•©/ë¦¬ë­í¬**ê¹Œì§€ í•œ ë²ˆì— ëŒì•„ê°‘ë‹ˆë‹¤. RAG íŒŒì´í”„ë¼ì¸ì— ë°”ë¡œ ë„£ê¸° ì¢‹ìŠµë‹ˆë‹¤.

---

## 1) ê°œë…: ì™œ â€œê³„ì¸µí˜•â€ì¸ê°€?

1. **ì¥ë¬¸Â·ëŒ€ê·œëª¨ KBì—ì„œì˜ ë‚œì **

   * í•œ ë²ˆì— ì „ë¶€ ì„ë² ë”©/ê²€ìƒ‰í•˜ë©´ **ë…¸ì´ì¦ˆâ†‘Â·ë¹„ìš©â†‘**.
   * LLMì€ ê¸´ ì…ë ¥ì—ì„œ **ì¤‘ê°„ ìœ„ì¹˜ ê·¼ê±°**ë¥¼ ìì£¼ ë†“ì¹©ë‹ˆë‹¤(â€œLost in the Middleâ€). ê³„ì¸µí˜•ìœ¼ë¡œ **ìƒìœ„ ìš”ì•½/ì„¹ì…˜ì—ì„œ í›„ë³´ë¥¼ ì¢íŒ ë’¤**, í•˜ìœ„ì—ì„œ ì •ë°€íˆ ì¬ê²€ìƒ‰Â·ì¬ë­í¬í•˜ë©´ ì´ ë¬¸ì œë¥¼ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

2. **í•µì‹¬ ì•„ì´ë””ì–´**

   * **ìƒìœ„ ë ˆë²¨**(ë¬¸ì„œÂ·ì„¹ì…˜Â·í´ëŸ¬ìŠ¤í„°Â·ìš”ì•½)ì—ì„œ **ì¡°-ëŒ€ì—­(coarse)** í›„ë³´ë¥¼ ë½‘ê³ ,
   * **í•˜ìœ„ ë ˆë²¨**(ë¬¸ë‹¨Â·ë¬¸ì¥Â·ìŠ¬ë¼ì´ë“œ ì¡°ê°)ì—ì„œ **ì„¸ë°€(fine)** ì¬ê²€ìƒ‰/ë¦¬ë­í¬.
   * í•„ìš” ì‹œ \*\*ì§ˆì˜ ë³´ì •/ë³´ê°•(HyDE ë“±)\*\*ê³¼ \*\*ìˆœìœ„ ìœµí•©(RRF)\*\*ìœ¼ë¡œ ê°•ê±´í™”.

3. **ëŒ€í‘œ ì—°êµ¬/íŒ¨í„´**

   * **RAPTOR**: ë¬¸ì„œë“¤ì„ **ìš”ì•½ íŠ¸ë¦¬**ë¡œ êµ¬ì„±(ë¬¸ë‹¨â†’ì„¹ì…˜ ìš”ì•½â†’ìƒìœ„ ìš”ì•½â€¦)í•˜ì—¬ **ë‹¤ì¸µì—ì„œ ê²€ìƒ‰**í•˜ê³  ê·¼ê±°ë¥¼ ëª¨ìë‹ˆë‹¤. ì¥ë¬¸ í•©ì„±Â·ë‹¤ë‹¨ê³„ ê·¼ê±°ì— ê°•í•¨.
   * **LongRefiner/ìµœê·¼ HR íŒ¨í„´ë“¤**: ìƒìœ„ ë ˆë²¨ ì„ ë³„ â†’ í•˜ìœ„ ë ˆë²¨ ì •ë°€ ì¶”ì¶œë¡œ **ì§€ì—°/ë¹„ìš©ì„ 10ë°° ì ˆê°**í•˜ë©´ì„œ ì •í™•ë„ ìœ ì§€/ìƒí–¥ì„ ë³´ê³ .
   * **Evidence Curationí˜• HR**: í‘œì¤€í™” ë¬¸ì„œ(ê¸ˆìœµ ë“±)ì—ì„œ ì¤‘ë³µ/êµ°ë”ë”ê¸°ë¥¼ ì œê±°í•˜ê³  **í•µì‹¬ ì¦ê±°ë¥¼ ì„ ë³„**í•´ ì§ˆì˜ì— ë§ì¶˜ ë³´ì¶© ì§ˆì˜ê¹Œì§€ ìˆ˜í–‰.

---

## 2) ì„¤ê³„ íŒ¨í„´(ì‹¤ë¬´ ì²´í¬ë¦¬ìŠ¤íŠ¸)

* **ì¸ë±ìŠ¤ êµ¬ì„±**

  * (A) **ì„¹ì…˜/ìš”ì•½ ë ˆë²¨ ì„ë² ë”© ì¸ë±ìŠ¤**(FAISS ë“±)
  * (B) **ë¬¸ë‹¨/ë¬¸ì¥ ë ˆë²¨ ì„¸ë¶€ ì¸ë±ìŠ¤**(BM25 + Dense í•˜ì´ë¸Œë¦¬ë“œ ê¶Œì¥)
  * (ì˜µì…˜) **ìš”ì•½ íŠ¸ë¦¬(RAPTOR)**: LLM/ë£° ê¸°ë°˜ìœ¼ë¡œ ìƒí–¥ì‹ ìš”ì•½ ë…¸ë“œ ìƒì„± í›„ ê° ë…¸ë“œ ì„ë² ë”©.

* **ì§ˆì˜ ì²˜ë¦¬ íë¦„**

  1. **Coarse Retrieval(ìƒìœ„)**: ì„¹ì…˜/ìš”ì•½ ì¸ë±ìŠ¤ì—ì„œ Top-S ì¶”ì¶œ
  2. **Candidate Expansion**: ì„ íƒ ì„¹ì…˜ í•˜ìœ„ ë¬¸ë‹¨/ë¬¸ì¥ í’€ë¡œ í™•ì¥
  3. **Fine Retrieval(í•˜ìœ„)**: BM25(ì •í™•í•œ í‚¤ì›Œë“œ ì¼ì¹˜) + Dense(ì˜ë¯¸ ìœ ì‚¬) ê²€ìƒ‰
  4. **ìˆœìœ„ ìœµí•©**: **RRF**ë¡œ BM25ì™€ Dense ê²°ê³¼ë¥¼ ê°„ë‹¨Â·ê°•ê±´í•˜ê²Œ ê²°í•©
  5. **(ì„ íƒ) í¬ë¡œìŠ¤-ë¦¬ë­í¬**: CrossEncoderë¡œ ìƒìœ„ Nê°œ ì •ë°€ ì¬ë­í¬
  6. **ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±**: ì„œë¡œ **ë³´ì™„ì ì¸ ê·¼ê±°**ê°€ ë‚˜ì˜¤ë„ë¡ ì¤‘ë³µ/ì¤‘ì–¸ ì œê±°
  7. **(ì˜µì…˜) HyDE/ë‹¤ì¤‘ ì§ˆì˜**: ë¶€ì¡±í•˜ë©´ ê°€ì„¤ ë¬¸ì„œë¥¼ ìƒì„±í•´ ì¬ê²€ìƒ‰, ë˜ëŠ” ì§ˆì˜ ë³€í˜•ì„ ë‹¤ì¤‘ ìƒì„± í›„ **RRF ìœµí•©**.

* **ë‹¤êµ­ì–´ ìµœì í™”**

  * ì„ë² ë”©ì€ **BGE-M3** ë˜ëŠ” **jina-embeddings-v3** ì¶”ì²œ(í•œêµ­ì–´/ì˜ì–´ í˜¼ì¬ì— ê°•í•¨). ì„¹ì…˜ ë©”íƒ€ì— `lang: ko|en` íƒœê¹…Â·ì´ì¤‘ ì œëª©(ko/en) í‚¤ì›Œë“œ ë¶€ì—¬.

---

## 3) ë¯¸ë‹ˆ ì˜ˆì‹œ

**ìƒí™©**: ìŠ¤ë§ˆíŠ¸í™ˆ ì œí’ˆ(í—ˆë¸Œ/ì—ì–´ì»¨/ì„¸íƒê¸°) ì˜¨ë³´ë”©Â·ì˜¤ë¥˜ì½”ë“œ ë§¤ë‰´ì–¼(í•œêµ­ì–´/ì˜ì–´ í˜¼ì¬).
**ì§ˆì˜**: â€œ**E23 ì˜¤ë¥˜ë¡œ Wi-Fi í˜ì–´ë§ì´ ì¤‘ë‹¨ë  ë•Œ ì¬ì‹œë„ ì ˆì°¨**â€
**ê³„ì¸µí˜• íë¦„**:

1. ì„¹ì…˜ ì¸ë±ìŠ¤ì—ì„œ â€œ*ë„¤íŠ¸ì›Œí¬ ì„¤ì •/ì—ëŸ¬ ì½”ë“œ í‘œ*â€ ì„¹ì…˜ì´ Top-Së¡œ ì„ íƒ.
2. ê·¸ ì„¹ì…˜ì˜ ë¬¸ë‹¨ í›„ë³´ì—ì„œ BM25(â€œE23â€, â€œí˜ì–´ë§â€, â€œì¬ì‹œë„â€)ì™€ Dense(ì˜ë¯¸ìœ ì‚¬)ë¡œ ìƒìœ„ ë¬¸ë‹¨ ì¶”ì¶œ.
3. RRFë¡œ ìœµí•© â†’ â€œE23=AP ê²©ë¦¬/2.4GHz ì „ìš©, ì¬ë¶€íŒ…â†’WPS ì˜¤í”„â†’ì¬ì‹œë„ 60ì´ˆâ€ ë¬¸ë‹¨ì´ 1ìœ„.
4. (ì„ íƒ) Cross-Encoderë¡œ ìµœì¢… 5ê°œ ë¬¸ë‹¨ ì •ë°€ ì¬ë­í¬.
   â†’ ì´ë ‡ê²Œ í•˜ë©´ ê¸´ ë§¤ë‰´ì–¼ ì „ì²´ë¥¼ ì§ì ‘ LLMì— ë„£ì„ ë•Œë³´ë‹¤ **ê·¼ê±° ì§‘ì¤‘ë„â†‘, í† í°â†“**.

---

## 4) íŒŒì´ì¬ ì˜ˆì œ ì½”ë“œ (FAISS + BM25 + RRF + ì„ íƒì  Cross-Encoder)

> ìš”êµ¬ ë¼ì´ë¸ŒëŸ¬ë¦¬
> `pip install sentence-transformers faiss-cpu rank_bm25 numpy scikit-learn`

```python
# -*- coding: utf-8 -*-
import re, math, json, numpy as np
from dataclasses import dataclass
from typing import List, Dict, Tuple
from sentence_transformers import SentenceTransformer, CrossEncoder
import faiss
from rank_bm25 import BM25Okapi

# ---------- 0) ìƒ˜í”Œ ì½”í¼ìŠ¤(ì„¹ì…˜/ë¬¸ë‹¨ êµ¬ì¡°) ----------
DOCS = [
    {
        "doc_id": "hub_guide_ko",
        "title": "ìŠ¤ë§ˆíŠ¸í—ˆë¸Œ ì„¤ì¹˜ ë° ë„¤íŠ¸ì›Œí¬ ê°€ì´ë“œ",
        "sections": [
            {
                "sec_id": "net_basics",
                "title": "ë„¤íŠ¸ì›Œí¬ ê¸°ë³¸ (2.4GHz ê¶Œì¥, AP ê²©ë¦¬ í•´ì œ)",
                "paragraphs": [
                    "ìŠ¤ë§ˆíŠ¸í—ˆë¸ŒëŠ” 2.4GHz ëŒ€ì—­ì—ì„œ ê°€ì¥ ì•ˆì •ì ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.",
                    "ê³µìœ ê¸°ì˜ AP ê²©ë¦¬ê°€ í™œì„±í™”ë˜ë©´ ê¸°ê¸° ê°„ í†µì‹ ì´ ì°¨ë‹¨ë˜ì–´ í˜ì–´ë§ì´ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                ]
            },
            {
                "sec_id": "error_codes",
                "title": "ì—ëŸ¬ ì½”ë“œ í‘œ (E2x/E3x)",
                "paragraphs": [
                    "E21: ë¼ìš°í„° ì¸ì¦ ì‹¤íŒ¨. ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸ í›„ ì¬ì‹œë„í•˜ì„¸ìš”.",
                    "E23: AP ê²©ë¦¬ ë˜ëŠ” ì„ì‹œ ë„¤íŠ¸ì›Œí¬ ì¶©ëŒë¡œ í˜ì–´ë§ ì¤‘ë‹¨. ê³µìœ ê¸° ì¬ë¶€íŒ… í›„ WPS ê¸°ëŠ¥ì„ ë„ê³  60ì´ˆ ë’¤ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.",
                    "E31: ì¸í„°ë„· ì—°ê²° ì—†ìŒ. ISP ëª¨ë€ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”."
                ]
            }
        ]
    },
    {
        "doc_id": "ac_manual_en",
        "title": "Air Conditioner Wi-Fi Setup & Troubleshooting",
        "sections": [
            {
                "sec_id": "pairing_steps",
                "title": "Pairing Steps (LED Blink Codes)",
                "paragraphs": [
                    "Use the app to start pairing. Ensure the device is in AP mode.",
                    "If pairing fails, reset the device and retry within 60 seconds."
                ]
            },
            {
                "sec_id": "error_table",
                "title": "Error Codes (E2x/E3x)",
                "paragraphs": [
                    "E23 indicates AP isolation or temporary interference. Reboot router, disable WPS, then retry.",
                    "E24 refers to DNS misconfiguration."
                ]
            }
        ]
    }
]

# ---------- 1) ìœ í‹¸ ----------
def flatten_sections(docs):
    """ì„¹ì…˜/ë¬¸ë‹¨ì„ í‰íƒ„í™”í•´ì„œ ì„¹ì…˜/ë¬¸ë‹¨ ë ˆë²¨ í…ìŠ¤íŠ¸ ë¦¬ìŠ¤íŠ¸ ìƒì„±"""
    section_texts, section_meta = [], []
    para_texts, para_meta = [], []
    for d in docs:
        for s in d["sections"]:
            # ì„¹ì…˜ ëŒ€í‘œ í…ìŠ¤íŠ¸: ì„¹ì…˜ ì œëª© + ì• ë¬¸ë‹¨ 1ê°œë¥¼ ê°„ë‹¨ ìš”ì•½ì²˜ëŸ¼ ì‚¬ìš©
            sec_text = f"{d['title']} > {s['title']}\n" + (s["paragraphs"][0] if s["paragraphs"] else "")
            section_texts.append(sec_text)
            section_meta.append({"doc_id": d["doc_id"], "sec_id": s["sec_id"], "title": s["title"]})

            for i, p in enumerate(s["paragraphs"]):
                para_texts.append(p)
                para_meta.append({
                    "doc_id": d["doc_id"], "sec_id": s["sec_id"],
                    "para_idx": i, "path": f"{d['title']} > {s['title']} > P{i+1}"
                })
    return section_texts, section_meta, para_texts, para_meta

# RRF(Reciprocal Rank Fusion)
def rrf_fuse(rank_lists: List[List[int]], k: int = 60) -> Dict[int, float]:
    """
    rank_lists: ê° ë­í‚¹ì—ì„œì˜ 'ë¬¸ì„œ ì¸ë±ìŠ¤' ë¦¬ìŠ¤íŠ¸(0ì´ 1ë“±)
    ë°˜í™˜: doc_idx -> fused_score
    """
    scores = {}
    for ranks in rank_lists:
        for r, doc_idx in enumerate(ranks):
            scores[doc_idx] = scores.get(doc_idx, 0.0) + 1.0 / (k + r + 1)
    return scores

# ---------- 2) ëª¨ë¸/ì¸ë±ìŠ¤ ì¤€ë¹„ ----------
# ë©€í‹°ë§êµ¬ì–¼ ê¶Œì¥: 'BAAI/bge-m3' (ëŒ€í˜•) ë˜ëŠ” 'paraphrase-multilingual-MiniLM-L12-v2'(ê²½ëŸ‰)
EMB_MODEL_NAME = "BAAI/bge-m3"
emb_model = SentenceTransformer(EMB_MODEL_NAME)

section_texts, section_meta, para_texts, para_meta = flatten_sections(DOCS)

# ì„ë² ë”© (ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ì‚¬ìš© ìœ„í•´ ì •ê·œí™”)
def embed(texts: List[str]) -> np.ndarray:
    X = emb_model.encode(texts, show_progress_bar=False, normalize_embeddings=True)
    return np.array(X, dtype="float32")

E_sec = embed(section_texts)
E_para = embed(para_texts)

# FAISS ì¸ë±ìŠ¤ (cosine = inner product with normalized vectors)
d = E_sec.shape[1]
sec_index = faiss.IndexFlatIP(d); sec_index.add(E_sec)
d2 = E_para.shape[1]
para_index = faiss.IndexFlatIP(d2); para_index.add(E_para)

# BM25 (ë¬¸ë‹¨ ë ˆë²¨)
tokenized_corpus = [re.findall(r"\w+", t.lower()) for t in para_texts]
bm25 = BM25Okapi(tokenized_corpus)

# (ì„ íƒ) í¬ë¡œìŠ¤-ë¦¬ë­ì»¤ (ë¬¸ë§¥ìƒ ì •í™•ë„ í–¥ìƒìš©)
# í•„ìš” ì‹œ ì£¼ì„ í•´ì œ
# cross_encoder = CrossEncoder("cross-encoder/ms-marco-MiniLM-L-6-v2")

# ---------- 3) ê³„ì¸µí˜• ê²€ìƒ‰ ----------
@dataclass
class Retrieved:
    text: str
    score: float
    meta: dict

def hierarchical_retrieve(query: str, top_sections=3, top_paras=5, use_cross=False) -> List[Retrieved]:
    # 1) ìƒìœ„(ì„¹ì…˜/ìš”ì•½) ê²€ìƒ‰
    q_vec = embed([query])
    D_sec, I_sec = sec_index.search(q_vec, top_sections)  # inner product == cosine (normalized)
    candidate_sec_ids = I_sec[0].tolist()

    # 2) í›„ë³´ ì„¹ì…˜ì˜ ë¬¸ë‹¨ë“¤ì„ ëª¨ì•„ 'ì„¸ë°€ ê²€ìƒ‰'
    candidate_para_idxs = []
    for sec_id in candidate_sec_ids:
        sec = section_meta[sec_id]
        # ë™ì¼ ì„¹ì…˜ì˜ ë¬¸ë‹¨ë“¤ ì¸ë±ìŠ¤ ìˆ˜ì§‘
        for i, m in enumerate(para_meta):
            if m["sec_id"] == sec["sec_id"] and m["doc_id"] == sec["doc_id"]:
                candidate_para_idxs.append(i)

    candidate_para_idxs = list(dict.fromkeys(candidate_para_idxs))  # ì¤‘ë³µ ì œê±° ìœ ì§€

    # 2-a) Dense(FAISS) ì ìˆ˜
    E_q = q_vec
    D_p_all, I_p_all = para_index.search(E_q, len(para_texts))
    # í›„ë³´ë§Œ í•„í„°
    dense_rank = [idx for idx in I_p_all[0].tolist() if idx in candidate_para_idxs][:max(top_paras*5, 20)]

    # 2-b) BM25 ì ìˆ˜
    tokenized_query = re.findall(r"\w+", query.lower())
    bm25_scores = bm25.get_scores(tokenized_query)
    # í›„ë³´ë§Œ í•„í„°í•œ BM25 ë­í¬
    bm25_pairs = [(i, bm25_scores[i]) for i in candidate_para_idxs]
    bm25_rank = [i for i, _ in sorted(bm25_pairs, key=lambda x: x[1], reverse=True)][:max(top_paras*5, 20)]

    # 3) RRF ìœµí•©
    fused = rrf_fuse([dense_rank, bm25_rank], k=60)
    fused_rank = [i for i, _ in sorted(fused.items(), key=lambda x: x[1], reverse=True)][:max(top_paras, 8)]

    results = [Retrieved(para_texts[i], fused[i], para_meta[i]) for i in fused_rank]

    # 4) (ì„ íƒ) í¬ë¡œìŠ¤-ë¦¬ë­í¬ë¡œ ìµœì¢… ì •ë°€ ì •ë ¬
    if use_cross:
        pairs = [[query, r.text] for r in results]
        ce_scores = CrossEncoder("cross-encoder/ms-marco-MiniLM-L-6-v2").predict(pairs)
        for r, s in zip(results, ce_scores):
            r.score = float(s)
        results = sorted(results, key=lambda x: x.score, reverse=True)

    return results

# ---------- 4) ë™ì‘ ì˜ˆì‹œ ----------
if __name__ == "__main__":
    query = "E23 ì˜¤ë¥˜ë¡œ Wi-Fi í˜ì–´ë§ì´ ì¤‘ë‹¨ë  ë•Œ ì–´ë–»ê²Œ ì¬ì‹œë„í•˜ë‚˜ìš”?"
    hits = hierarchical_retrieve(query, top_sections=2, top_paras=5, use_cross=False)
    print(f"[Query] {query}\n")
    for rank, h in enumerate(hits, 1):
        print(f"#{rank} score={h.score:.4f} | {h.meta['path']}")
        print("  ", h.text)
```

### ì½”ë“œ ì„¤ëª… ìš”ì 

* **ìƒìœ„ ë‹¨ê³„**: ì„¹ì…˜(ì œëª© + ì²« ë¬¸ë‹¨ ìš”ì•½ ëŒ€ìš©) ì„ë² ë”©ìœ¼ë¡œ **FAISS ì½”ì‚¬ì¸ ê²€ìƒ‰**.
* **í•˜ìœ„ ë‹¨ê³„**: ìƒìœ„ì—ì„œ ê³ ë¥¸ ì„¹ì…˜ ì•ˆì˜ ë¬¸ë‹¨ë§Œ ëŒ€ìƒìœ¼ë¡œ **Dense + BM25** ì´ì¤‘ ê²€ìƒ‰.
* **RRF ìœµí•©**: ê°„ë‹¨í•˜ê³  ê°•ê±´í•œ ë­í‚¹ ìœµí•©ìœ¼ë¡œ **ë‘ ì„¸ê³„ì˜ ì¥ì  ê²°í•©**.
* **ì˜µì…˜**: Cross-Encoderë¡œ ìƒìœ„ Nê°œ **ì •ë°€ ì¬ë­í¬**(ì§ˆì˜-ë¬¸ë‹¨ ì˜ë¯¸ì  ì í•©ì„± ì ìˆ˜).
* **ë‹¤êµ­ì–´**: `BAAI/bge-m3`ëŠ” í•œêµ­ì–´/ì˜ì–´ í˜¼ì¬ì— ê°•í•¨(ì› ë…¼ë¬¸/Findings ë³´ê³ ).

---

## 5) ê³ ê¸‰í™” í¬ì¸íŠ¸

1. **RAPTORì‹ ìš”ì•½ íŠ¸ë¦¬**

* ë¬¸ë‹¨â†’ì„¹ì…˜ ìš”ì•½â†’ë¬¸ì„œ ìš”ì•½ìœ¼ë¡œ **íŠ¸ë¦¬ ë…¸ë“œ**ë¥¼ ë§Œë“¤ê³ , **ë…¸ë“œ ì„ë² ë”©**ì„ ì¸ë±ì‹± â†’ **íŠ¸ë¦¬ ìœ„ì—ì„œ ë‚´ë ¤ì˜¤ë©°** coarseâ†’fine ê²€ìƒ‰.

2. **ë³´ì¶© ì§ˆì˜/HyDE/ë‹¤ì¤‘ì§ˆì˜ + ìœµí•©**

* ì§ˆì˜ê°€ ëª¨í˜¸í•˜ë©´ **ê°€ì„¤ ë¬¸ì„œ(HyDE)** ìƒì„± í›„ ì¬ê²€ìƒ‰, ë˜ëŠ” **ì§ˆì˜ ë³€í˜•** ë‹¤ì¤‘ ìƒì„± â†’ **RRF**ë¡œ ê²°ê³¼ ìœµí•©.

3. **ì¦ê±° íë ˆì´ì…˜(Evidence Curation)**

* í‘œì¤€ ë¬¸ì„œì˜ ì¤‘ë³µ/êµ°ë”ë”ê¸° ì œê±°, **ë³´ì™„ ì •ë³´ ì§ˆì˜**ê¹Œì§€ ìˆ˜í–‰í•˜ì—¬ **ê·¼ê±° ì¶©ì‹¤ë„** í–¥ìƒ.

4. **í‰ê°€/íŠœë‹**

* \*\*top-S(ì„¹ì…˜)\*\*ê³¼ \*\*top-k(ë¬¸ë‹¨)\*\*ì„ ê°ê° íŠœë‹.
* BM25ì˜ `k1`, `b`, ë¬¸ë‹¨ í¬ê¸°(ì˜ˆ: 120~~200ë‹¨ì–´, stride 30~~50), ìš”ì•½ ê¸¸ì´, ì–¸ì–´ íƒœê·¸ ë“±ì„ í•¨ê»˜ ìµœì í™”.
* ë¡±ì»¨í…ìŠ¤íŠ¸ ë¬¸ì œëŠ” ì—¬ì „íˆ ì¡´ì¬í•˜ë¯€ë¡œ, **ê³„ì¸µí˜•ìœ¼ë¡œ ì¤‘ê°„ ê·¼ê±°ë¥¼ ì•ìª½ì— ë°°ì¹˜**í•´ íˆ¬ì…í•˜ì„¸ìš”.

---

## 6) ì°¸ê³  ìë£Œ(í´ë¦­í•´ í™•ì¸)

* **RAPTOR(ìš”ì•½ íŠ¸ë¦¬ ê¸°ë°˜ ê³„ì¸µí˜• ê²€ìƒ‰)**: arXiv/ìš”ì•½ í˜ì´ì§€.
* **ë¡±ì»¨í…ìŠ¤íŠ¸ í•œê³„(Lost in the Middle)**: ìŠ¤íƒ í¼ë“œ/ì• ë¦¬ì¡°ë‚˜ ë“± ì—°êµ¬.
* **RRF(ìˆœìœ„ ìœµí•©)**: SIGIR/ACM ë° ì› ë…¼ë¬¸ PDF.
* **BM25(í™•ë¥ ì  ê´€ë ¨ë„ í”„ë ˆì„ì›Œí¬)**: ê°œê´€Â·ì„œë² ì´.
* **LongRefiner/ìµœê·¼ HR ë™í–¥**(ë¡±í…ìŠ¤íŠ¸ RAG íš¨ìœ¨í™”).
* **ë‹¤êµ­ì–´ ì„ë² ë”©**: BGE-M3, jina-embeddings-v3.

---

## ë§ˆë¬´ë¦¬

* ìœ„ ì½”ë“œëŠ” **í˜„ì‹¤ì ì¸ HR íŒŒì´í”„ë¼ì¸ì˜ ìµœì†Œ ê³¨ê²©**ì…ë‹ˆë‹¤.
* ìš´ì˜ì—ì„œëŠ” ì—¬ê¸°ì— **ì¦ë¶„ ì¸ë±ì‹±(ì„¹ì…˜/ë¬¸ë‹¨ì— ë²„ì „ íƒœê·¸)**, **ì–¸ì–´/ì œí’ˆë³„ ì˜¤ë²„ë ˆì´**, **Self-RAGì‹ ì¬ê²€ìƒ‰ ê²Œì´íŒ…**, **í¬ë¡œìŠ¤-ë¦¬ë­ì»¤ ë°°ì¹˜ ìµœì í™”**ë¥¼ ì–¹ìœ¼ì‹œë©´ **ì •í™•ë„Â·ë¹„ìš©Â·ì§€ì—°**ì˜ ê· í˜•ì´ ì¡í™ë‹ˆë‹¤. í•„ìš”í•˜ì‹œë©´ ê·€í•˜ì˜ IoT KB ìŠ¤í‚¤ë§ˆì— ë§ì¶° **RAPTOR-ìŠ¤íƒ€ì¼ ìš”ì•½ íŠ¸ë¦¬ ìƒì„± ìŠ¤í¬ë¦½íŠ¸**ë„ ë°”ë¡œ êµ¬ì„±í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

---

> ê·¸ë˜ RAPTOR ìŠ¤íƒ€ì¼ ìš”ì•½ íŠ¸ë¦¬ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ë„ êµ¬ì„±í•´ì¤˜.
> ê·¸ë¦¬ê³  self-RAG ì¬ê²€ìƒ‰ ê²Œì´íŒ…ê³¼ í¬ë¡œìŠ¤-ë¦¬ë­ì»¤ ë°°ì¹˜ìµœì í™”ë„ ì¶”ê°€í•´ì¤˜.

# ìš”ì•½

* **RAPTOR ìŠ¤íƒ€ì¼ ìš”ì•½ íŠ¸ë¦¬ ìƒì„±ê¸° + Self-RAG ì¬ê²€ìƒ‰ ê²Œì´íŒ… + í¬ë¡œìŠ¤-ë¦¬ë­ì»¤ ë°°ì¹˜ ìµœì í™”**ë¥¼ í•œ ë²ˆì— ëŒë¦´ ìˆ˜ ìˆëŠ” **ì‹¤ì „ìš© ë¯¸ë‹ˆ ë ˆí¬**ë¥¼ ì¤€ë¹„í•´ ë“œë ¸ìŠµë‹ˆë‹¤.
* í¬í•¨ ë‚´ìš©: íŠ¸ë¦¬ ë¹Œë”(ë¬¸ì„œâ†’ì²­í¬â†’ìš”ì•½ íŠ¸ë¦¬), ê³„ì¸µí˜• ê²€ìƒ‰(Coarseâ†’Fine), BM25+Dense **RRF ìœµí•©**, **Self-RAG ê²Œì´íŒ…**(LLM/íœ´ë¦¬ìŠ¤í‹±), **Cross-Encoder ë¦¬ë­í¬**(ë°°ì¹˜ í¬ê¸° ìë™ ì¡°ì ˆ) ë°ëª¨.
* ë°”ë¡œ ë‚´ë ¤ë°›ì•„ ì‹¤í–‰í•´ ë³´ì‹œê³ , Ollama/vLLM í™˜ê²½ì— ë§ì¶° ìš”ì•½ê¸°Â·ê²Œì´íŒ… LLMë§Œ ì—°ê²°í•˜ì‹œë©´ ë©ë‹ˆë‹¤.

[ğŸ“¦ raptor\_hr\_demo.zip ë‹¤ìš´ë¡œë“œ](sandbox:/mnt/data/raptor_hr_demo.zip)

---

ì•„ë˜ëŠ” **êµ¬ì„± ì„¤ëª…ê³¼ ì‚¬ìš© ë°©ë²•**, **í•µì‹¬ ì½”ë“œ ê°œìš”**, **íŠœë‹ í¬ì¸íŠ¸**ì…ë‹ˆë‹¤.

---

## 1) ë ˆí¬ êµ¬ì„±

```
raptor_hr_demo/
  README_ko.md                 # ì‚¬ìš© ë°©ë²•
  requirements.txt
  sample_docs/
    hub_guide_ko.md
    ac_manual_en.md
    router_troubleshooting_ko.md
  raptor_tree.py               # RAPTOR ìŠ¤íƒ€ì¼ ìš”ì•½ íŠ¸ë¦¬ + ë ˆë²¨ë³„ FAISS ì¸ë±ìŠ¤
  retrieval_pipeline.py        # ê³„ì¸µí˜• ê²€ìƒ‰ + BM25+Dense RRF + (ì˜µì…˜) Cross-Encoder
  selfrag_gating.py            # Self-RAG ê²Œì´íŒ…(LLM/íœ´ë¦¬ìŠ¤í‹±) + ì§ˆì˜ ì¬ì‘ì„±
  demo.py                      # ì¸ë±ìŠ¤ ìƒì„± í›„ ì§ˆì˜ ì‹¤í–‰ ë°ëª¨ ì—”íŠ¸ë¦¬
```

> ìƒ˜í”Œ ë¬¸ì„œëŠ” í•œêµ­ì–´/ì˜ì–´ í˜¼ì¬(E23 ì˜¤ë¥˜ ë“±)ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

---

## 2) ì„¤ì¹˜ & ë¹ ë¥¸ ì‹¤í–‰

```bash
# ê°€ìƒí™˜ê²½
python -m venv .venv && source .venv/bin/activate  # Windows: .venv\Scripts\activate

# ì˜ì¡´ì„±
pip install -r requirements.txt
```

### 2-1) ìš”ì•½ íŠ¸ë¦¬ + ì¸ë±ìŠ¤ ìƒì„±

```bash
python raptor_tree.py \
  --docs_dir ./sample_docs \
  --out_dir ./artifacts \
  --branch_factor 6 \
  --levels 3 \
  --chunk_words 120
```

* **Ollamaë¡œ ì‹¤ì œ ìš”ì•½ ì‚¬ìš©**(ê¶Œì¥):

```bash
python raptor_tree.py \
  --docs_dir ./sample_docs \
  --out_dir ./artifacts \
  --branch_factor 6 --levels 3 --chunk_words 120 \
  --summarizer ollama --ollama_model llama3:instruct --ollama_url http://127.0.0.1:11434
```

> ê¸°ë³¸ê°’ì€ **ê°„ì´ ìš”ì•½(naive)** ì´ë©°, í”„ë¡œë•ì…˜ì—ì„œëŠ” ê¼­ **ë¡œì»¬ LLM**ìœ¼ë¡œ ìš”ì•½ì„ ìƒì„±í•˜ì„¸ìš”.

### 2-2) Self-RAG ê²Œì´íŒ… + ê³„ì¸µí˜• ê²€ìƒ‰ + Cross-Encoder ë¦¬ë­í¬

```bash
python demo.py \
  --artifacts ./artifacts \
  --query "E23 ì˜¤ë¥˜ë¡œ Wi-Fi í˜ì–´ë§ì´ ì¤‘ë‹¨ë  ë•Œ ì–´ë–»ê²Œ ì¬ì‹œë„í•˜ë‚˜ìš”?" \
  --use_selfrag \
  --use_cross \
  --cross_model cross-encoder/ms-marco-MiniLM-L-6-v2
```

* ì½˜ì†” ì¶œë ¥ ì˜ˆì‹œ(ìš”ì•½):

  * `[Self-RAG Gate] {"need_search": true, "k": 6, "rewrites": ["..."]}`
  * `=== ìµœì¢… í›„ë³´ ë¬¸ë‹¨ ===`ì™€ í•¨ê»˜ RRF ì ìˆ˜, Cross-Encoder ì ìˆ˜ë¡œ ì •ë ¬ëœ ë¬¸ë‹¨ ëª©ë¡

> `--use_selfrag` ì‹œ í˜„ì¬ëŠ” **íœ´ë¦¬ìŠ¤í‹± ê²Œì´íŠ¸**(ìˆ«ì/ì˜¤ë¥˜ì½”ë“œ/ë²„ì „/ìµœì‹ ì„± í‚¤ì›Œë“œ ê°ì§€).
> `selfrag_gating.py`ì—ì„œ `use_llm=True`ë¡œ ë°”ê¾¸ë©´ **Ollama LLM JSON ê²Œì´íŠ¸**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

---

## 3) í•µì‹¬ êµ¬ì„± ìš”ì†Œ ìš”ì•½

### 3-1) RAPTOR ìŠ¤íƒ€ì¼ ìš”ì•½ íŠ¸ë¦¬ (`raptor_tree.py`)

* **Leaf(0ë ˆë²¨)**: ë¬¸ì„œ â†’ ê³ ì • ê¸¸ì´ **ì²­í¬**ë¡œ ë¶„í• (`--chunk_words`, `--stride_words`).
* **ìƒìœ„ ë ˆë²¨**: **branch\_factor**ë§Œí¼ í•˜ìœ„ ë…¸ë“œë¥¼ ë¬¶ì–´ **ìš”ì•½ ìƒì„±** â†’ **ë¶€ëª¨ ë…¸ë“œ** ìƒì„±.
* **ë ˆë²¨ë³„ FAISS ì¸ë±ìŠ¤** ìƒì„±: `faiss_level{L}.index` + `emb_level{L}.npy` + `nodes_level{L}.jsonl`
* ìš”ì•½ê¸°ëŠ” **`Summarizer`** í´ë˜ìŠ¤ë¡œ ì¶”ìƒí™”:

  * `mode="ollama"`: `http://127.0.0.1:11434/api/generate` í˜¸ì¶œ
  * `mode="naive"`: ê°„ì´ ìš”ì•½(ì²« ë¬¸ì¥ ê¸°ë°˜)

> íŠ¸ë¦¬ ê¹Šì´(`--levels`)ì™€ í­(`--branch_factor`)ì€ ë°ì´í„° í¬ê¸°/ì„±ê²©ì— ë§ì¶° ì¡°ì •í•˜ì‹­ì‹œì˜¤(ê¸´ ë§¤ë‰´ì–¼ì€ ê¹Šì´ 3~~4, branch 6~~12 ê¶Œì¥).

### 3-2) ê³„ì¸µí˜• ê²€ìƒ‰ + RRF ìœµí•© (`retrieval_pipeline.py`)

* **Coarse ë‹¨ê³„**: **ìƒìœ„ ë ˆë²¨**(rootì— ê°€ê¹Œìš´ ë ˆë²¨)ì—ì„œ **Top-S** í›„ë³´ ìš”ì•½ ë…¸ë“œ ê²€ìƒ‰ â†’ í•˜ìœ„ë¡œ **ìì‹ í™•ì¥**.
* **Fine ë‹¨ê³„**: ì„ íƒëœ ìì‹ë“¤(ëŒ€ê°œ leaf í›„ë³´)ì— ëŒ€í•´

  * **Dense**(SentenceTransformer ì„ë² ë”©) + **BM25** í•¨ê»˜ ìˆ˜í–‰
  * \*\*RRF(Reciprocal Rank Fusion)\*\*ë¡œ **ê°•ê±´ ìœµí•©**
* ê²°ê³¼ëŠ” leaf ì¸ë±ìŠ¤ì™€ í•¨ê»˜ ë°˜í™˜ â†’ ìƒì„± ë‹¨ê³„ì—ì„œ **ì¸ìš©Â·í•˜ì´ë¼ì´íŠ¸** êµ¬ì„±ì— ì‚¬ìš©

### 3-3) Self-RAG ì¬ê²€ìƒ‰ ê²Œì´íŒ… (`selfrag_gating.py`)

* **LLM ê²Œì´íŠ¸(ê¶Œì¥)**:

  * ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì— ë”°ë¼ **JSONë§Œ** ë°˜í™˜: `{"need_search": bool, "k": int, "rewrites": [...]}`
  * ìµœì‹ ì„±Â·ê²€ì¦ í•„ìš”Â·ê³ ìœ ëª…ì‚¬/ë²„ì „/ì½”ë“œÂ·ë§í¬ ìš”êµ¬ ì‹œ `need_search=true` ê¶Œì¥
* **íœ´ë¦¬ìŠ¤í‹± ê²Œì´íŠ¸(ê¸°ë³¸)**:

  * â€œì˜¤ë¥˜/E23/ë²„ì „/ìµœì‹ /URL/ì ˆì°¨/ìˆ«ìâ€ ë“± í¬í•¨ ì‹œ ê²€ìƒ‰ í•„ìš”ë¡œ íŒë‹¨
  * **ì§ˆì˜ ì¬ì‘ì„±(rewrites)**: í‚¤ì›Œë“œ ì¤‘ì‹¬ ë²„ì „ ì¶”ê°€ â†’ **ë‹¤ì¤‘ ì§ˆì˜ ê²€ìƒ‰ + ìœµí•©**ì— í™œìš©

### 3-4) í¬ë¡œìŠ¤-ë¦¬ë­ì»¤ ë°°ì¹˜ ìµœì í™” (`demo.py`)

* **CrossEncoder**(`ms-marco-MiniLM-L-6-v2`)ë¡œ ìƒìœ„ Nê°œë¥¼ **ì •ë°€ ì¬ë­í¬**
* ì…ë ¥ ê¸¸ì´ì— ë”°ë¥¸ **ë°°ì¹˜ í¬ê¸° ìë™ ì¡°ì ˆ**(ê°„ë‹¨ íœ´ë¦¬ìŠ¤í‹±) â†’ GPU/CPU ëª¨ë‘ ì•ˆì •ì 
* í”„ë¡œë•ì…˜ì—ì„œëŠ” **ë¡œë”ë¥¼ ì „ì—­ 1íšŒ ì´ˆê¸°í™”**í•˜ê³ , íë¥¼ ì¨ì„œ **ë°°ì¹˜ ë³‘í•©**(micro-batching)í•˜ë©´ Throughputâ†‘

---

## 4) ì‹¤ë¬´ íŠœë‹ ê°€ì´ë“œ

1. **íŠ¸ë¦¬ íŒŒë¼ë¯¸í„°**

* `chunk_words`: 100~~180 ë‹¨ì–´ ê¶Œì¥(í•œêµ­ì–´ëŠ” ë¬¸ì¥ ê¸¸ì´ ê°ì•ˆ), `stride_words`: 1/3~~1/2
* `branch_factor`: 6~~12, `levels`: 3~~4 (ì½”í¼ìŠ¤ ê·œëª¨ê°€ í¬ê³  ë¬¸ì„œê°€ ê¸¸ìˆ˜ë¡ ìƒí–¥)

2. **ì„ë² ë”© ëª¨ë¸**

* ë‹¤êµ­ì–´ KB(í•œ/ì˜ í˜¼ì¬)ëŠ” **BGE-M3** ë˜ëŠ” **jina-embeddings-v3** ê¶Œì¥.
* ë„ë©”ì¸ íŠ¹í™” ìš©ì–´ê°€ ë§ë‹¤ë©´ **ë„ë©”ì¸ íŠœë‹**(CAUTION: ë¼ì´ì„ ìŠ¤ì™€ ë°ì´í„° ë³´í˜¸)

3. **ë¦¬íŠ¸ë¦¬ë²Œ íŒŒì´í”„ë¼ì¸**

* **Top-S(ìƒìœ„)**, **Top-k(leaf)**, **RRF kê°’**, **BM25 k1/b**ë¥¼ A/Bë¡œ ìµœì í™”
* **ë‹¤ì¤‘ ì§ˆì˜(ì§ˆì˜ ì¬ì‘ì„±/HyDE)** + **RRF ìœµí•©**ìœ¼ë¡œ ê°•ê±´ì„±â†‘
* **Cross-Encoder**ëŠ” ìƒìœ„ 20\~50ê°œë§Œ ë¦¬ë­í¬ â†’ **ì§€ì—°/ë¹„ìš©** ì œì–´

4. **Self-RAG ê²Œì´íŒ…**

* â€œë‚ ì§œ/ë²„ì „/ì½”ë“œ/ëª¨ë¸ëª…/ë§í¬/ë²•ê·œ/ìˆ˜ì¹˜/ì˜¤ë¥˜ì½”ë“œ/ì œí’ˆëª…â€ í¬í•¨ ì‹œ ëŒ€ë¶€ë¶„ ê²€ìƒ‰
* ê²Œì´íŠ¸ê°€ ì‚°ì¶œí•œ `k`ë¥¼ **ì •ì±…**(SLAÂ·ë¹„ìš©)ê³¼ ì—°ë™(ì˜ˆ: ëª¨ë°”ì¼=ì‘ê²Œ, ì„œë²„=í¬ê²Œ)
* LLM ê²Œì´íŠ¸ ì¶œë ¥ì´ ë¶ˆì•ˆì •í•˜ë©´ **JSON íŒŒì„œ + ë°±ì˜¤í”„** ë° **íœ´ë¦¬ìŠ¤í‹± í´ë°±** ìœ ì§€

5. **ìš´ì˜Â·ê´€ì¸¡**

* **RAGAS** ë“±ìœ¼ë¡œ *Answer Correctness, Faithfulness, Context Precision/Recall* ëª¨ë‹ˆí„°ë§
* **ì¦ë¶„ ì¸ë±ì‹±**: ë¬¸ì„œ ë²„ì „Â·ì–¸ì–´ íƒœê·¸(`lang: ko|en`)ë¥¼ ë©”íƒ€ì— ì¶”ê°€
* **ê·¼ê±° í•˜ì´ë¼ì´íŠ¸**: leaf ë¬¸ì¥ í† í°í™” í›„ ìŠ¤íŒ¬ ë§¤ì¹­ ë˜ëŠ” Cross-Attention ê¸°ë°˜ í•˜ì´ë¼ì´íŠ¸

---

## 5) ë‹¤ìŒ ë‹¨ê³„

* ì›í•˜ì‹œë©´ **FastAPI + Web UI(í•˜ì´ë¼ì´íŠ¸/ì¶œì²˜ í‘œì‹œ, ìŠ¤íŠ¸ë¦¬ë°)**,
  **Redis/PG Checkpoint**, **BM25+FAISS í•˜ì´ë¸Œë¦¬ë“œ ê°€ì¤‘ì¹˜ íŠœë„ˆ**ë¥¼ ìœ„ ë ˆí¬ì— ê·¸ëŒ€ë¡œ **ì¶”ê°€ íŒ¨ì¹˜**í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.
* ë˜í•œ **Ollama/vLLM** ì–‘ìª½ ëª¨ë‘ì—ì„œ ë™ì‘í•˜ëŠ” **ëª¨ë¸ ì–´ëŒ‘í„° ë ˆì´ì–´**ë¥¼ ì–¹ì–´, ìš”ì•½/ê²Œì´íŒ…/ìƒì„± ëª¨ë‘ë¥¼ **êµì²´ ê°€ëŠ¥**í•˜ê²Œ ì¼ë°˜í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í•„ìš”í•˜ì‹  ì„¸ë¶€ ì¡°ì •(ë¸Œëœì¹˜/ë ˆë²¨/ì„ë² ë”© êµì²´/HyDEÂ·ë‹¤ì¤‘ì§ˆì˜Â·ì„¸ì…˜ ìºì‹œ/ë¦¬ë­í¬ ì •ì±…) ë§ì”€ ì£¼ì‹œë©´ ì¦‰ì‹œ ë°˜ì˜í•˜ì—¬ **íŒ¨ì¹˜ ë²„ì „**ìœ¼ë¡œ ì¬êµ¬ì„±í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

---

> ê³„ì¸µí˜• retrieval ì— ëŒ€í•´ ìì„¸íˆ ì•Œë ¤ì¤˜. ì˜ˆì‹œë¥¼ ë³´ì—¬ì£¼ê³  ì½”ë“œë„ ì œì‹œí•´ì¤˜.
> RAPTOR ìŠ¤íƒ€ì¼ ìš”ì•½ íŠ¸ë¦¬ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ë„ êµ¬ì„±í•´ì¤˜. ê·¸ë¦¬ê³  self-RAG ì¬ê²€ìƒ‰ ê²Œì´íŒ…ê³¼ í¬ë¡œìŠ¤-ë¦¬ë­ì»¤ ë°°ì¹˜ìµœì í™”ë„ ì¶”ê°€í•´ì¤˜.
> Ollama/vLLM ì–‘ìª½ ëª¨ë‘ì—ì„œ ë™ì‘í•˜ëŠ” ëª¨ë¸ ì–´ëŒ‘í„° ë ˆì´ì–´ë¥¼ ì–¹ì–´, ìš”ì•½/ê²Œì´íŒ…/ìƒì„± ëª¨ë‘ë¥¼ êµì²´ ê°€ëŠ¥í•˜ê²Œ ì¼ë°˜í™”í•´ì¤˜

# ìš”ì•½

* \*\*ê³„ì¸µí˜• Retrieval(HR)\*\*ì˜ ê°œë…ê³¼ ì¥ì , ì‹¤ì œ **RAPTOR ìŠ¤íƒ€ì¼ ìš”ì•½ íŠ¸ë¦¬** êµ¬ì¶• ì ˆì°¨ì™€ **Self-RAG ì¬ê²€ìƒ‰ ê²Œì´íŒ…**Â·**í¬ë¡œìŠ¤-ë¦¬ë­ì»¤ ë°°ì¹˜ ìµœì í™”**ë¥¼ í•œ ë²ˆì— êµ¬í˜„í•œ **ì‹¤ì „ìš© ë ˆí¬**ë¥¼ ì œê³µí•´ ë“œë ¸ìŠµë‹ˆë‹¤.
* **Ollama / vLLM(OpenAI-í˜¸í™˜)** ì–‘ìª½ì„ ì§€ì›í•˜ëŠ” **ëª¨ë¸ ì–´ëŒ‘í„° ë ˆì´ì–´**ë¥¼ í¬í•¨í•˜ì—¬, **ìš”ì•½(íŠ¸ë¦¬ ìƒì„±) / ê²Œì´íŒ… / ìƒì„±(Answer)** ì„ ëª¨ë‘ **êµì²´ ê°€ëŠ¥í•œ êµ¬ì¡°**ë¡œ ì¼ë°˜í™”í–ˆìŠµë‹ˆë‹¤.
* ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ ìƒ˜í”Œ ë¬¸ì„œì™€ ìŠ¤í¬ë¦½íŠ¸ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.

[ğŸ“¦ hr\_raptor\_adapter.zip ë‹¤ìš´ë¡œë“œ](sandbox:/mnt/data/hr_raptor_adapter.zip)

---

## 1) ê³„ì¸µí˜• Retrieval ê°œë… ì •ë¦¬ (ì‹¤ë¬´ ê´€ì )

1. **ì™œ ê³„ì¸µí˜•ì¸ê°€?**

* ê¸´ ë§¤ë‰´ì–¼/ê·œê²©ì„œ/í¬ëŸ¼ ê°™ì€ ëŒ€ê·œëª¨ KBì—ì„œ í•œ ë²ˆì— ì „ ë²”ìœ„ë¥¼ ê²€ìƒ‰í•˜ë©´ \*\*ë…¸ì´ì¦ˆâ†‘Â·ë¹„ìš©â†‘\*\*ì…ë‹ˆë‹¤.
* HRì€ **ìƒìœ„(ìš”ì•½/ì„¹ì…˜) â†’ í•˜ìœ„(ë¬¸ë‹¨/ë¬¸ì¥)** ë‹¨ê³„ë¡œ í›„ë³´ë¥¼ ì¢í˜€ **ì •í™•ë„(ê·¼ê±°ì¶©ì‹¤ë„)**Â·\*\*íš¨ìœ¨(í† í°/ì§€ì—°/ë¹„ìš©)\*\*ì„ ë™ì‹œì— ì¡ìŠµë‹ˆë‹¤.

2. **íë¦„**

* (Coarse) **ìƒìœ„ ë ˆë²¨** ìš”ì•½/ì„¹ì…˜ ì¸ë±ìŠ¤ì—ì„œ Top-S â†’
* (Expand) í•´ë‹¹ ì„¹ì…˜ì˜ í•˜ìœ„ ì²­í¬(ë¬¸ë‹¨/ë¬¸ì¥)ë¡œ í™•ì¥ â†’
* (Fine) **Dense + BM25** í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ â†’ **RRF ìœµí•©** â†’
* (ì˜µì…˜) **Cross-Encoder**ë¡œ ìƒìœ„ Nê°œ ì •ë°€ ë¦¬ë­í¬ â†’ **ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±**.

3. **RAPTOR ìŠ¤íƒ€ì¼**

* ë¬¸ë‹¨(leaf)ë“¤ì„ **branch\_factor**ë¡œ ë¬¶ì–´ **ê·¸ë£¹ ìš”ì•½**ì„ ë§Œë“¤ê³ , ê·¸ ìš”ì•½ë“¤ë¼ë¦¬ ë‹¤ì‹œ ë¬¶ì–´ ìƒìœ„ ìš”ì•½â€¦
* ì´ë ‡ê²Œ **ìš”ì•½ íŠ¸ë¦¬**ë¥¼ ë§Œë“¤ë©´, ìƒìœ„ ë…¸ë“œ(ìš”ì•½)ì—ì„œ ë¹ ë¥´ê²Œ Coarse ê²€ìƒ‰ í›„ ìì‹ ë°©í–¥ìœ¼ë¡œ Fineí•˜ê²Œ ë‚´ë ¤ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

4. **Self-RAG ê²Œì´íŒ…**

* â€œê²€ìƒ‰ì´ í•„ìš”í•œê°€?â€, â€œTop-këŠ” ëª‡ ê°œ?â€, â€œì§ˆì˜ ì¬ì‘ì„±(rewrites)ì´ í•„ìš”í•œê°€?â€ë¥¼ **LLM/ë£°**ë¡œ ê²°ì • â†’ **ë¶ˆí•„ìš”í•œ ê²€ìƒ‰ì„ ì–µì œ**í•˜ë©´ì„œë„ **ì •í™•ë„** ìœ ì§€.

5. **í¬ë¡œìŠ¤-ë¦¬ë­ì»¤ ë°°ì¹˜ ìµœì í™”**

* ë¬¸ì¥ìŒ í‰ê°€(CrossEncoder)ë¡œ ì •ë°€ ë¦¬ë­í¬ ì‹œ **ì…ë ¥ ê¸¸ì´ ê¸°ë°˜ ë°°ì¹˜ í¬ê¸° ìë™ ì¡°ì ˆ**(ê°„ë‹¨ íœ´ë¦¬ìŠ¤í‹±) â†’ GPU/CPU ëª¨ë‘ ì•ˆì •ì  ì²˜ë¦¬ëŸ‰ í™•ë³´.

---

## 2) ë ˆí¬ êµ¬ì„± ë° ì„¤ì¹˜

```
hr_raptor_adapter/
  README_ko.md
  requirements.txt
  sample_docs/
    hub_guide_ko.md
    ac_manual_en.md
    router_troubleshooting_ko.md
  adapters/
    model_adapter.py          # Ollama / OpenAI-í˜¸í™˜(vLLM) ì–´ëŒ‘í„°
  raptor_tree.py              # RAPTOR íŠ¸ë¦¬ ìƒì„±(+ìš”ì•½ê¸° í”ŒëŸ¬ê·¸)
  retrieval_pipeline.py       # HR + BM25+Dense RRF + (ì˜µì…˜) Cross-ë¦¬ë­í¬
  selfrag_gating.py           # Self-RAG ê²Œì´íŠ¸(LLM/íœ´ë¦¬ìŠ¤í‹±)
  demo.py                     # ê²Œì´íŠ¸â†’ê²€ìƒ‰â†’ë¦¬ë­í¬â†’(ìƒì„±) ì—”ë“œ-íˆ¬-ì—”ë“œ ë°ëª¨
```

ì„¤ì¹˜:

```bash
python -m venv .venv && source .venv/bin/activate   # Windows: .venv\Scripts\activate
pip install -r requirements.txt
```

---

## 3) RAPTOR ìŠ¤íƒ€ì¼ ìš”ì•½ íŠ¸ë¦¬ ìƒì„±

### 3-1) ê°„ì´ ìš”ì•½(LLM ë¯¸ì‚¬ìš©)

```bash
python raptor_tree.py \
  --docs_dir ./sample_docs \
  --out_dir ./artifacts \
  --branch_factor 6 --levels 3 --chunk_words 120 \
  --llm_backend none
```

### 3-2) Ollama ìš”ì•½ ì‚¬ìš©

```bash
python raptor_tree.py \
  --docs_dir ./sample_docs \
  --out_dir ./artifacts \
  --branch_factor 6 --levels 3 --chunk_words 120 \
  --llm_backend ollama \
  --llm_model llama3:instruct \
  --llm_base_url http://127.0.0.1:11434
```

### 3-3) vLLM(OpenAI-í˜¸í™˜) ìš”ì•½ ì‚¬ìš©

```bash
python raptor_tree.py \
  --docs_dir ./sample_docs \
  --out_dir ./artifacts \
  --branch_factor 6 --levels 3 --chunk_words 120 \
  --llm_backend openai \
  --llm_model qwen2.5-7b-instruct \
  --llm_base_url http://127.0.0.1:8000/v1 \
  --llm_api_key sk-xxx
```

> ìƒì„± ì‚°ì¶œë¬¼: `artifacts/nodes_level{0..L}.jsonl`, `emb_level{L}.npy`, `faiss_level{L}.index`, `tree_meta.json`

---

## 4) Self-RAG ê²Œì´íŒ… + ê³„ì¸µí˜• ê²€ìƒ‰ + Cross-ë¦¬ë­í¬

### 4-1) ê¸°ë³¸ ì‹¤í–‰(íœ´ë¦¬ìŠ¤í‹± ê²Œì´íŠ¸)

```bash
python demo.py \
  --artifacts ./artifacts \
  --query "E23 ì˜¤ë¥˜ë¡œ Wi-Fi í˜ì–´ë§ì´ ì¤‘ë‹¨ë  ë•Œ ì–´ë–»ê²Œ ì¬ì‹œë„í•˜ë‚˜ìš”?" \
  --use_selfrag --selfrag_backend heuristic \
  --use_cross --cross_model cross-encoder/ms-marco-MiniLM-L-6-v2
```

### 4-2) LLM ê¸°ë°˜ Self-RAG ê²Œì´íŠ¸ (Ollama)

```bash
python demo.py \
  --artifacts ./artifacts \
  --query "..." \
  --use_selfrag --selfrag_backend ollama \
  --llm_model llama3:instruct \
  --llm_base_url http://127.0.0.1:11434 \
  --use_cross --cross_model cross-encoder/ms-marco-MiniLM-L-6-v2
```

### 4-3) LLM ê¸°ë°˜ Self-RAG ê²Œì´íŠ¸ (vLLM/OpenAI-í˜¸í™˜)

```bash
python demo.py \
  --artifacts ./artifacts \
  --query "..." \
  --use_selfrag --selfrag_backend openai \
  --llm_model qwen2.5-7b-instruct \
  --llm_base_url http://127.0.0.1:8000/v1 --llm_api_key sk-xxx \
  --use_cross --cross_model cross-encoder/ms-marco-MiniLM-L-6-v2
```

### 4-4) (ì˜µì…˜) ìƒì„± ë‹¨ê³„ê¹Œì§€ ì‹¤í–‰

```bash
python demo.py \
  --artifacts ./artifacts \
  --query "E23 ì˜¤ë¥˜..." \
  --use_selfrag --selfrag_backend heuristic \
  --use_cross \
  --do_generate --gen_backend ollama \
  --llm_model llama3:instruct --llm_base_url http://127.0.0.1:11434
```

* ì„ íƒëœ í›„ë³´ ë¬¸ë‹¨ë“¤ì„ bulletë¡œ ë¬¶ì–´ **ê·¼ê±°/ì¶œì²˜ í¬í•¨ ë‹µë³€**ì„ ìƒì„±í•©ë‹ˆë‹¤.
* vLLM(OpenAI-í˜¸í™˜)ë¡œë„ ë™ì¼í•˜ê²Œ `--gen_backend openai`ë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.

---

## 5) í•µì‹¬ ì½”ë“œ ìŠ¤ë‹ˆí«

### 5-1) ëª¨ë¸ ì–´ëŒ‘í„° ë ˆì´ì–´ (Ollama / OpenAI-í˜¸í™˜)

```python
# adapters/model_adapter.py (ë°œì·Œ)
class BaseLLM: ...
class OllamaClient(BaseLLM):
    def generate(self, system, user, model, **kw):
        prompt = (f"[System]\n{system}\n\n" if system else "") + f"[User]\n{user}"
        body = {"model": model, "prompt": prompt, "stream": False, ...}
        return requests.post(f"{base}/api/generate", json=body).json()["response"]
class OpenAICompatClient(BaseLLM):
    def generate(self, system, user, model, **kw):
        messages = [{"role":"system","content":system},{"role":"user","content":user}]
        body = {"model": model, "messages": messages, "temperature": 0.2, ...}
        return requests.post(f"{base}/chat/completions", json=body, headers=...).json()["choices"][0]["message"]["content"]
```

### 5-2) RAPTOR ìš”ì•½ íŠ¸ë¦¬ ë¹Œë”

```python
# raptor_tree.py (ë°œì·Œ)
for lvl in range(1, levels):
    prev = levels_nodes[-1]
    groups = [prev[i:i+branch] for i in range(0, len(prev), branch)]
    cur = []
    for g in groups:
        summary = summarize_group([n.text for n in g], llm_backend, llm_base_url, llm_api_key, llm_model)
        parent = Node(level=lvl, text=summary, children=[n.node_id for n in g], ...)
        for n in g: n.parent = parent.node_id
        cur.append(parent)
    levels_nodes.append(cur)
# ê° ë ˆë²¨ í…ìŠ¤íŠ¸ ì„ë² ë”© â†’ FAISS ì¸ë±ìŠ¤ ì €ì¥
```

### 5-3) HR + BM25+Dense RRF + Cross-ë¦¬ë­ì»¤

```python
# retrieval_pipeline.py (ë°œì·Œ)
# ìƒìœ„ ë ˆë²¨ Top-S ê²€ìƒ‰ â†’ ìì‹ leaf í›„ë³´ í™•ì¥
D, I = level_idx[lvl].search(qv, top_sections)  # cosine(IP on normalized)
# leaf í›„ë³´ì— ëŒ€í•´ Dense(FAISS) + BM25
fused = rrf_fuse([dense_rank, bm25_rank], k=60)
# demo.py: CrossEncoderë¡œ ìƒìœ„ Nê°œ ì •ë°€ ì¬ë­í¬ + ë°°ì¹˜ í¬ê¸° ìë™ ì¡°ì ˆ
```

### 5-4) Self-RAG ê²Œì´íŒ…(JSON)

```python
# selfrag_gating.py (ë°œì·Œ)
SYS = "Return STRICT JSON: {need_search: bool, k: int, rewrites: [str,...]}"
resp = client.generate(SYS, user=f"Query: {query}\nReturn JSON ONLY.", model=llm_model, response_format="json_object")
data = try_parse_json(resp.text) or heuristic_gate(query)
```

---

## 6) íŠœë‹ ê°€ì´ë“œ

* **íŠ¸ë¦¬ íŒŒë¼ë¯¸í„°**: `chunk_words(100~180)`, `stride(1/3~1/2)`, `branch(6~12)`, `levels(3~4)`
* **í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰**: Top-S/Top-k, RRFì˜ `k`(ê¸°ë³¸ 60), BM25 `k1/b`ë¥¼ A/Bë¡œ ìµœì í™”
* **Cross-ë¦¬ë­í¬**: ìƒìœ„ 20\~50ê°œë§Œ ë¦¬ë­í¬, ë°°ì¹˜ ìë™ ì¡°ì ˆ + ë§ˆì´í¬ë¡œë°°ì¹­ìœ¼ë¡œ ì²˜ë¦¬ëŸ‰â†‘
* **Self-RAG**: ë‚ ì§œ/ë²„ì „/ì½”ë“œ/ë§í¬/ì˜¤ë¥˜ ì½”ë“œ/ì œí’ˆëª…Â·ê·œê²© ë“±ì€ ê²€ìƒ‰ í•„ìš”ë¡œ íŒì •, `k`ëŠ” SLA/ë¹„ìš©ì— ì—°ë™
* **ë‹¤êµ­ì–´**: ë¬¸ì„œ ë©”íƒ€ì— `lang: ko|en`, ì œëª©/í‚¤ì›Œë“œ ì´ì¤‘ í‘œê¸°, ì„ë² ë”©ì€ BGE-M3 ê¶Œì¥
* **ìš´ì˜/ê´€ì¸¡**: RAGAS ë“±ìœ¼ë¡œ *Correctness/Faithfulness/Context Precision-Recall* ìƒì‹œ ëª¨ë‹ˆí„°ë§, ì¦ë¶„ ì¸ë±ì‹±/ë²„ì €ë‹

---

## 7) ë‹¤ìŒ ë‹¨ê³„ ì œì•ˆ

* **FastAPI + Web UI**(í•˜ì´ë¼ì´íŠ¸/ì¶œì²˜ í‘œì‹œ, ìŠ¤íŠ¸ë¦¬ë°) í†µí•©
* **BM25+FAISS í•˜ì´ë¸Œë¦¬ë“œ ê°€ì¤‘ì¹˜ íŠœë„ˆ**(Grid/Hyperband) ì¶”ê°€
* **ì„¸ì…˜ ìºì‹œ/ì¬ê²€ìƒ‰ ì •ì±…(ê²Œì´íŠ¸ ì„ê³„ê°’)**, **HyDE/ë‹¤ì¤‘ ì§ˆì˜ RRF ìœµí•©** í™•ì¥
* **ëª¨ë¸ ì–´ëŒ‘í„° ë ˆì´ì–´**ì— **í•¨ìˆ˜ í˜¸ì¶œ/íˆ´ ì‚¬ìš© í”„ë¡¬í”„íŠ¸**Â·**ì•ˆì „ ë¼ìš°íŒ…(êµ­ê°€ë³„ ì •ì±… ì˜¤ë²„ë ˆì´)** ì—°ê³„

ì›í•˜ì‹œë©´ ìœ„ ë ˆí¬ì— ë°”ë¡œ **FastAPI + UI + Adapter ë¼ìš°íŒ…**ì„ íŒ¨ì¹˜í•˜ì—¬, ê·€í•˜ì˜ ì˜¨í”„ë ˆë¯¸ìŠ¤ í™˜ê²½(Ollama/vLLM)ì—ì„œ ê³§ì¥ ìš´ì˜ ê°€ëŠ¥í•œ í˜•íƒœë¡œ í™•ì¥í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.


---
---
---


> ì•„ë˜ ë‚´ìš© ì¶”ê°€í•´ì¤˜
> 
> - BM25+FAISS í•˜ì´ë¸Œë¦¬ë“œ ê°€ì¤‘ì¹˜ íŠœë„ˆ(Grid/Hyperband) ì¶”ê°€
> - ì„¸ì…˜ ìºì‹œ/ì¬ê²€ìƒ‰ ì •ì±…(ê²Œì´íŠ¸ ì„ê³„ê°’), HyDE/ë‹¤ì¤‘ ì§ˆì˜ RRF ìœµí•© í™•ì¥
> - ëª¨ë¸ ì–´ëŒ‘í„° ë ˆì´ì–´ì— í•¨ìˆ˜ í˜¸ì¶œ/íˆ´ ì‚¬ìš© í”„ë¡¬í”„íŠ¸Â·ì•ˆì „ ë¼ìš°íŒ…(êµ­ê°€ë³„ ì •ì±… ì˜¤ë²„ë ˆì´) ì—°ê³„

# ìš”ì•½

ìš”ì²­í•˜ì‹  ì„¸ í•­ëª©ì„ **ì™„ì „ ë°˜ì˜**í•´ ìƒˆ ë²„ì „ìœ¼ë¡œ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.

* **BM25+FAISS í•˜ì´ë¸Œë¦¬ë“œ ê°€ì¤‘ì¹˜ íŠœë„ˆ(Grid/Hyperband)**: `tuner.py` (ìë™ìœ¼ë¡œ `rrf/weighted` ìœµí•©ê³¼ `dense_w/bm25_w` ìµœì í™”)
* **ì„¸ì…˜ ìºì‹œ/ì¬ê²€ìƒ‰ ì •ì±…(ê²Œì´íŠ¸ ì„ê³„ê°’), HyDE/ë‹¤ì¤‘ ì§ˆì˜ RRF ìœµí•©**: `demo.py` í”Œë˜ê·¸ ë° `session_cache.py`, `hyde_multiquery.py`
* **ëª¨ë¸ ì–´ëŒ‘í„° ë ˆì´ì–´ì— í•¨ìˆ˜ í˜¸ì¶œ/íˆ´ í”„ë¡¬í”„íŠ¸Â·ì•ˆì „ ë¼ìš°íŒ…(êµ­ê°€ë³„ ì •ì±… ì˜¤ë²„ë ˆì´)**: `adapters/model_adapter.py` + `policies/policy_overlays.yaml`

  * OpenAI-í˜¸í™˜(vLLM) ê²½ë¡œì— **tools/tool\_choice**ê°€ ì‹¤ì œë¡œ ì „ë‹¬ë˜ë„ë¡ **ì™„ì „ ì—°ê²°**í•´ë‘ì—ˆìŠµë‹ˆë‹¤.

[ğŸ“¦ hr\_raptor\_adapter\_v3.zip ë‹¤ìš´ë¡œë“œ](sandbox:/mnt/data/hr_raptor_adapter_v3.zip)

---

## ìì„¸í•œ ì„¤ëª…

### 1) BM25+FAISS í•˜ì´ë¸Œë¦¬ë“œ ê°€ì¤‘ì¹˜ íŠœë„ˆ

* íŒŒì¼: `tuner.py`
* ë°©ì‹:

  1. **Grid**ë¡œ `alpha=dense_w âˆˆ {0.0, 0.25, 0.5, 0.75, 1.0}`ì™€ `method âˆˆ {rrf, weighted}` ì „ì—­ íƒìƒ‰
  2. ìµœì  ë¶€ê·¼ì„ **ë¯¸ì„¸ íƒìƒ‰**(ê°„ë‹¨ Hyperband ìŠ¤íƒ€ì¼)
* ë©”íŠ¸ë¦­(ì˜ˆì‹œ): top-1 í›„ë³´ ë¬¸ë‹¨ì— `keywords` ì¤‘ í•˜ë‚˜ ì´ìƒ í¬í•¨ ì—¬ë¶€(0/1). ì‹¤ì „ì—ì„œëŠ” **EM/F1**, **RAGAS**, í˜¹ì€ íœ´ë¨¼ ë¼ë²¨ë¡œ êµì²´ ê¶Œì¥.
* ì‚¬ìš©:

```bash
python tuner.py --artifacts ./artifacts --eval_file ./eval_set.jsonl --out_file tuner_results.json
```

* `demo.py` ì‹¤í–‰ ì‹œ `tuner_results.json`ì´ ì¡´ì¬í•˜ë©´ **ìë™ ë°˜ì˜**(ìœµí•© ë°©ì‹/ê°€ì¤‘ì¹˜).

### 2) ì„¸ì…˜ ìºì‹œ / ê²Œì´íŠ¸ ì„ê³„ê°’ / HyDEÂ·ë‹¤ì¤‘ ì§ˆì˜ RRF í™•ì¥

* **ì„¸ì…˜ ìºì‹œ**: `session_cache.py` (TTLÂ·ê°„ë‹¨ LRU)

  * `demo.py`ì˜ `--use_cache --cache_ttl 600`ë¡œ í™œì„±í™”
  * keyëŠ” ì§ˆì˜ ì¬ì‘ì„± ì¡°í•© ê¸°ì¤€ìœ¼ë¡œ êµ¬ì„±
* **ì¬ê²€ìƒ‰ ì •ì±…(ê²Œì´íŠ¸ ì„ê³„ê°’)**:

  * Self-RAG ê²Œì´íŠ¸ê°€ ë°˜í™˜í•œ `k` ê¸°ë°˜ìœ¼ë¡œ `--gate_threshold` ì´ìƒì´ë©´ ê²€ìƒ‰ ìˆ˜í–‰
  * ì˜ˆ) `--gate_threshold 5` â†’ ê²Œì´íŠ¸ê°€ `k=4`ë©´ ê²€ìƒ‰ ìƒëµ
* **HyDE/ë‹¤ì¤‘ ì§ˆì˜**: `hyde_multiquery.py`

  * `--use_hyde --multiquery_n 2` ë¡œ í™œì„±í™” â†’ LLM(ë˜ëŠ” íœ´ë¦¬ìŠ¤í‹±)ë¡œ ê°€ì„¤ ë¬¸ë‹¨/ì§ˆì˜ ìƒì„± â†’ ê¸°ì¡´ rewritesì™€ í•¨ê»˜ **RRF/ê°€ì¤‘ ìœµí•©**
  * ë¹„ìš©/ì§€ì—° ì œì–´ë¥¼ ìœ„í•´ `multiquery_n`ê³¼ ì§ˆì˜ ê¸¸ì´ ì œí•œì„ ì¡°ì ˆ
* ì‹¤í–‰ ì˜ˆ:

```bash
python demo.py --artifacts ./artifacts \
  --query "E23 ì˜¤ë¥˜ë¡œ Wi-Fi í˜ì–´ë§ì´ ì¤‘ë‹¨ë  ë•Œ ì–´ë–»ê²Œ ì¬ì‹œë„í•˜ë‚˜ìš”?" \
  --use_selfrag --selfrag_backend heuristic \
  --use_hyde --multiquery_n 2 \
  --use_cache --cache_ttl 600 \
  --fusion weighted --dense_w 0.6 --bm25_w 0.4 \
  --use_cross --cross_model cross-encoder/ms-marco-MiniLM-L-6-v2
```

### 3) ì–´ëŒ‘í„° ë ˆì´ì–´: í•¨ìˆ˜ í˜¸ì¶œ/íˆ´ í”„ë¡¬í”„íŠ¸ + ì•ˆì „ ë¼ìš°íŒ…(êµ­ê°€ë³„ ì •ì±…)

* íŒŒì¼: `adapters/model_adapter.py`

  * **Ollama**: `/api/generate`
  * **OpenAI-í˜¸í™˜(vLLM ë“±)**: `/v1/chat/completions`
  * `OpenAICompatClient.generate(...)`ê°€ `tools`/`tool_choice` íŒŒë¼ë¯¸í„°ë¥¼ **ì‹¤ì œë¡œ bodyì— í¬í•¨**í•˜ë„ë¡ êµ¬í˜„
* **ì•ˆì „ ë¼ìš°íŒ…**: `SafetyRouter`

  * `policies/policy_overlays.yaml`ì˜ êµ­ê°€ ì½”ë“œ(KR/US ë“±)ë³„ **system prefix**, **blocked\_tools** ì‚¬ìš©
  * `demo.py` ìƒì„± ë‹¨ê³„ì—ì„œ overlay ì ìš© í›„, **ì°¨ë‹¨ëœ íˆ´ ìë™ í•„í„°ë§**
* ìƒì„± ë‹¨ê³„ ì˜ˆ:

```bash
python demo.py --artifacts ./artifacts \
  --query "E23 ì˜¤ë¥˜..." \
  --use_selfrag --selfrag_backend openai \
  --llm_model qwen2.5-7b-instruct --llm_base_url http://127.0.0.1:8000/v1 --llm_api_key sk-xxx \
  --use_hyde --multiquery_n 2 --use_cache \
  --do_generate --gen_backend openai \
  --policy_overlays ./policies/policy_overlays.yaml --country_code KR
```

---

## í´ë” êµ¬ì¡° ìš”ì•½

```
hr_raptor_adapter_v3/
  README_ko.md
  requirements.txt
  sample_docs/
  policies/
    policy_overlays.yaml             # êµ­ê°€ë³„ ì •ì±… ì˜¤ë²„ë ˆì´
  adapters/
    model_adapter.py                 # Ollama / OpenAI-í˜¸í™˜ í´ë¼ì´ì–¸íŠ¸ + SafetyRouter + tools ì „ë‹¬
  raptor_tree.py                     # RAPTOR ìš”ì•½ íŠ¸ë¦¬ ë¹Œë”
  retrieval_pipeline.py              # HR + RRF/ê°€ì¤‘ ìœµí•©
  selfrag_gating.py                  # Self-RAG ê²Œì´íŠ¸(LLM/íœ´ë¦¬ìŠ¤í‹±)
  hyde_multiquery.py                 # HyDE/ë‹¤ì¤‘ ì§ˆì˜ ìƒì„±
  session_cache.py                   # TTL ìºì‹œ
  tuner.py                           # Grid/Hyperband íŠœë„ˆ
  eval_set.jsonl                     # ì˜ˆì‹œ í‰ê°€ì…‹
```

---

## ì‹¤ë¬´ íŒ

* **íŠœë„ˆ ë©”íŠ¸ë¦­**ì„ ë°˜ë“œì‹œ ë„ë©”ì¸ìš©ìœ¼ë¡œ êµì²´(ì •ë‹µ ë¼ë²¨/ë£¨ë¸Œë¦­).
* **HyDE**ëŠ” í’ˆì§ˆ í¸ì°¨ê°€ í½ë‹ˆë‹¤. ë‹¤ì¤‘/ê°€ì„¤ ì§ˆì˜ëŠ” 1\~3ê°œ ì •ë„ë¡œ ì œí•œí•˜ê³ , Cross-ë¦¬ë­í¬ë¡œ **ì •ë°€ í•„í„°ë§**í•˜ì„¸ìš”.
* **ì •ì±… ì˜¤ë²„ë ˆì´**ëŠ” êµ­ê°€Â·ì œí’ˆêµ°Â·ê·œì œ ë ˆë²¨ë³„ë¡œ ì„¸ë¶„í™” ê°€ëŠ¥(ì˜ˆ: `KR:home_appliance`, `KR:medical`, â€¦).
* **íˆ´ ì‚¬ìš©**ì€ OpenAI-í˜¸í™˜ ë°±ì—”ë“œì— ìµœì í™”ë˜ì–´ ìˆìœ¼ë‹ˆ, íˆ´ ê²°ê³¼ í•¸ë“¤ëŸ¬(ì˜ˆ: `open_url`) ì—°ê²°ë§Œ ì¶”ê°€í•˜ë©´ **í•¨ìˆ˜ í˜¸ì¶œ ë£¨í”„**ë¡œ í™•ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

í•„ìš”í•˜ì‹œë©´ **FastAPI + Web UI(ì¶œì²˜ í•˜ì´ë¼ì´íŠ¸/íˆ´ ë²„íŠ¼/ìŠ¤íŠ¸ë¦¬ë°)**, **ì¦ë¶„ ì¸ë±ì‹± íŒŒì´í”„ë¼ì¸**, **ë‹¤ì¤‘ ë°±ì—”ë“œ ë¹„ìš©/ì •ì±… ê¸°ë°˜ ë¼ìš°íŒ…**ê¹Œì§€ ë°”ë¡œ í™•ì¥í•´ ë“œë¦´ê²Œìš”.

